<!doctype html><!-- This site was created with Hugo Blox. https://hugoblox.com --><!-- Last Published: December 14, 2024 --><html lang=en-us dir=ltr data-wc-theme-default=light><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo Blox Builder 0.2.0"><meta name=description content="THE NIRB TWO-GRID METHOD
Script by Elise Grosjean (elise.grosjean@ensta-paris.fr)
import sys
!{sys.executable} -m pip install numpy
!{sys.executable} -m pip install matplotlib
!{sys.executable} -m pip install scikit-fem
Let us consider a parameterized problem.
The NIRB two-grid method follows the same ideas as in the Snapshot Proper Orthogonal Decomposition (POD) algorithm and is decomposed in two parts:"><link rel=alternate hreflang=en-us href=https://reducedbasis.github.io/post/nirb2grid/><link rel=stylesheet href=/css/themes/blue.min.css><link href=/dist/wc.min.css rel=stylesheet><script>window.hbb={defaultTheme:document.documentElement.dataset.wcThemeDefault,setDarkTheme:()=>{document.documentElement.classList.add("dark"),document.documentElement.style.colorScheme="dark"},setLightTheme:()=>{document.documentElement.classList.remove("dark"),document.documentElement.style.colorScheme="light"}},console.debug(`Default Hugo Blox Builder theme is ${window.hbb.defaultTheme}`),"wc-color-theme"in localStorage?localStorage.getItem("wc-color-theme")==="dark"?window.hbb.setDarkTheme():window.hbb.setLightTheme():(window.hbb.defaultTheme==="dark"?window.hbb.setDarkTheme():window.hbb.setLightTheme(),window.hbb.defaultTheme==="system"&&(window.matchMedia("(prefers-color-scheme: dark)").matches?window.hbb.setDarkTheme():window.hbb.setLightTheme()))</script><script>document.addEventListener("DOMContentLoaded",function(){let e=document.querySelectorAll("li input[type='checkbox'][disabled]");e.forEach(e=>{e.parentElement.parentElement.classList.add("task-list")});const t=document.querySelectorAll(".task-list li");t.forEach(e=>{let t=Array.from(e.childNodes).filter(e=>e.nodeType===3&&e.textContent.trim().length>1);if(t.length>0){const n=document.createElement("label");t[0].after(n),n.appendChild(e.querySelector("input[type='checkbox']")),n.appendChild(t[0])}})})</script><link rel=icon type=image/png href=/media/icon_hu16304263275779960481.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu1534112029185156839.png><link rel=canonical href=https://reducedbasis.github.io/post/nirb2grid/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@GetResearchDev"><meta property="twitter:creator" content="@GetResearchDev"><meta property="og:site_name" content="RBM Docs"><meta property="og:url" content="https://reducedbasis.github.io/post/nirb2grid/"><meta property="og:title" content="RBM Docs"><meta property="og:description" content="THE NIRB TWO-GRID METHOD
Script by Elise Grosjean (elise.grosjean@ensta-paris.fr)
import sys
!{sys.executable} -m pip install numpy
!{sys.executable} -m pip install matplotlib
!{sys.executable} -m pip install scikit-fem
Let us consider a parameterized problem.
The NIRB two-grid method follows the same ideas as in the Snapshot Proper Orthogonal Decomposition (POD) algorithm and is decomposed in two parts:"><meta property="og:image" content="https://reducedbasis.github.io/media/icon_hu8177510199143947247.png"><meta property="twitter:image" content="https://reducedbasis.github.io/media/icon_hu8177510199143947247.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-12-13T10:19:20+01:00"><meta property="article:modified_time" content="2024-12-13T10:19:20+01:00"><title>RBM Docs</title><style>@font-face{font-family:inter var;font-style:normal;font-weight:100 900;font-display:swap;src:url(/dist/font/Inter.var.woff2)format(woff2)}</style><link type=text/css rel=stylesheet href=/dist/pagefind/pagefind-ui.be766eb419317a14ec769d216e9779bfe8f3737c80e780f4ba0dafb57a41a482.css integrity="sha256-vnZutBkxehTsdp0hbpd5v+jzc3yA54D0ug2vtXpBpII="><script src=/dist/pagefind/pagefind-ui.87693d7c6f2b3b347ce359d0ede762c033419f0a32b22ce508c335a81d841f1b.js integrity="sha256-h2k9fG8rOzR841nQ7ediwDNBnwoysizlCMM1qB2EHxs="></script><script>window.hbb.pagefind={baseUrl:"/"}</script><style>html.dark{--pagefind-ui-primary:#eeeeee;--pagefind-ui-text:#eeeeee;--pagefind-ui-background:#152028;--pagefind-ui-border:#152028;--pagefind-ui-tag:#152028}</style><script>window.addEventListener("DOMContentLoaded",e=>{new PagefindUI({element:"#search",showSubResults:!0,baseUrl:window.hbb.pagefind.baseUrl,bundlePath:window.hbb.pagefind.baseUrl+"pagefind/"})}),document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("search"),t=document.getElementById("search_toggle");t&&t.addEventListener("click",()=>{if(e.classList.toggle("hidden"),e.querySelector("input").value="",e.querySelector("input").focus(),!e.classList.contains("hidden")){let t=document.querySelector(".pagefind-ui__search-clear");t&&!t.hasAttribute("listenerOnClick")&&(t.setAttribute("listenerOnClick","true"),t.addEventListener("click",()=>{e.classList.toggle("hidden")}))}})})</script><link type=text/css rel=stylesheet href=/dist/lib/katex/katex.min.505d5f829022bb7b4f24dfee0aa1141cd7bba67afe411d1240335f820960b5c3.css integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM="><script defer src=/dist/lib/katex/katex.min.dc84b296ec3e884de093158f760fd9d45b6c7abe58b5381557f4e138f46a58ae.js integrity="sha256-3ISyluw+iE3gkxWPdg/Z1Ftser5YtTgVV/ThOPRqWK4="></script><script defer src=/js/katex-renderer.6579ec9683211cfb952064aedf3a3baea5eeb17a061775b32b70917474637c80.js integrity="sha256-ZXnsloMhHPuVIGSu3zo7rqXusXoGF3WzK3CRdHRjfIA="></script><script defer src=/js/hugo-blox-en.min.e5fa931947cac2d947732ea37a770aae2b5bd4a50b6048060cd129b46159a06d.js integrity="sha256-5fqTGUfKwtlHcy6jencKritb1KULYEgGDNEptGFZoG0="></script></head><body class="dark:bg-hb-dark dark:text-white page-wrapper" id=top><div id=page-bg></div><div class="page-header sticky top-0 z-30"><header id=site-header class=header><nav class="navbar px-3 flex justify-left"><div class="order-0 h-100"><a class=navbar-brand href=/ title="RBM Docs"><img fetchpriority=high decoding=async width=49 height=36 src=/media/logo_hu9071661120962382538.webp alt="RBM Docs"></a></div><input id=nav-toggle type=checkbox class=hidden>
<label for=nav-toggle class="order-3 cursor-pointer flex items-center lg:hidden text-dark dark:text-white lg:order-1"><svg id="show-button" class="h-6 fill-current block" viewBox="0 0 20 20"><title>Open Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg><svg id="hide-button" class="h-6 fill-current hidden" viewBox="0 0 20 20"><title>Close Menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="navbar-nav order-3 hidden lg:flex w-full pb-6 lg:order-1 lg:w-auto lg:space-x-2 lg:pb-0 xl:space-x-8 justify-left"><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class=nav-link href=/docs/>Documentation</a></li><li class=nav-item><a class=nav-link href=/blog/>News</a></li><li class=nav-item><a class=nav-link href=/showcase/>Other examples</a></li><li class=nav-item><a class=nav-link href=/events/>Events</a></li><li class="mt-4 inline-block lg:hidden"><a href=/>Get Started</a></li></ul><div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0"><button aria-label=search class="text-black hover:text-primary inline-block px-3 text-xl dark:text-white" id=search_toggle><svg height="16" width="16" viewBox="0 0 512 512" fill="currentcolor"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg></button><div class="px-3 text-black hover:text-primary-700 dark:text-white dark:hover:text-primary-300
[&.active]:font-bold [&.active]:text-black/90 dark:[&.active]:text-white"><button class="theme-toggle mt-1" accesskey=t title=appearance><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dark:hidden"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dark:block [&:not(dark)]:hidden"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div><a href=/ class="inline-block rounded border px-5 py-2 font-semibold transition
md:ml-4 px-4 py-1.5 text-sm
border-black hover:bg-black dark:hover:bg-white dark:hover:text-black hover:text-white dark:border-white dark:text-white dark:hover:bg-white
hidden lg:inline-block">Get Started</a></div></nav></header><div id=search class="hidden p-3"></div></div><div class="page-body my-10"><div class="mx-auto flex max-w-screen-xl"><aside class="hb-sidebar-container max-lg:[transform:translate3d(0,-100%,0)] lg:hidden xl:block"><div class="px-4 pt-4 lg:hidden"></div><div class="hb-scrollbar lg:h-[calc(100vh-var(--navbar-height))]"><ul class="flex flex-col gap-1 lg:hidden"><li class=open><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/>Posts
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/eim/>index</a></li><li class="flex flex-col open"><a class="hb-sidebar-custom-link
sidebar-active-item bg-primary-100 font-semibold text-primary-800 dark:bg-primary-300 dark:text-primary-900" href=/post/nirb2grid/>index</a><ul class=hb-sidebar-mobile-toc><li><a href=#1-the-2d-driven-cavity-problem class=hb-docs-link>1) The 2D-driven cavity problem:</a></li><li><a href=# class=hb-docs-link></a></li></ul></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/pbdwadv/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/pbdwhelmholtz/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/podgalerkin/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/podi/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/pbdw/>My Post</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/blog/>Recent and Upcoming methods
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/blog/v1.0.0/>PBDW v1 released!</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/blog/todolist/>TODO list</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/showcase/>More applications
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/showcase/cavity/>Cavity</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/>Documentation
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/pod/>POD-Galerkin</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/podi/>POD-Interpolation</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/eim/>EIM</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/pbdw/>PBDW</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/reference/>References</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/events/>Events</a></li></ul><div class="max-xl:hidden h-0 w-64 shrink-0"></div></div></aside><nav class="hb-toc order-last hidden w-64 shrink-0 xl:block print:hidden px-4" aria-label="table of contents"><div class="hb-scrollbar text-sm [hyphens:auto] sticky top-16 overflow-y-auto pr-4 pt-6 max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] -mr-4 rtl:-ml-4"><p class="mb-4 font-semibold tracking-tight">On this page</p><ul><li class="my-2 scroll-my-6 scroll-py-6"><a class="font-semibold inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#1-the-2d-driven-cavity-problem>1) The 2D-driven cavity problem:</a></li></ul><ul><li class="my-2 scroll-my-6 scroll-py-6"><a class="pl-4 rtl:pr-4 inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#nirb-two-grid-method>NIRB two-grid method</a></li><li class="my-2 scroll-my-6 scroll-py-6"><a class="pl-8 rtl:pr-8 inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#offline-part>OFFLINE PART</a></li></ul></div></nav><article class="w-full break-words flex min-h-[calc(100vh-var(--navbar-height))] min-w-0 justify-center pb-8 pr-[calc(env(safe-area-inset-right)-1.5rem)]"><main class="w-full min-w-0 max-w-6xl px-6 pt-4 md:px-12"><h1 class="mt-2 text-4xl font-bold tracking-tight text-slate-900 dark:text-slate-100"></h1><div class="mt-4 mb-16"><div class="text-gray-500 dark:text-gray-300 text-sm flex items-center flex-wrap gap-y-2"><span class=mr-1>Dec 13, 2024</span>
<span class=mx-1>·</span>
<span class=mx-1>12 min read</span></div><div class=mt-3></div></div><div class="prose prose-slate lg:prose-xl dark:prose-invert"><h1 id=the-nirb-two-grid-method>THE NIRB TWO-GRID METHOD</h1><p>Script by Elise Grosjean (<a href=mailto:elise.grosjean@ensta-paris.fr>elise.grosjean@ensta-paris.fr</a>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=p>{</span><span class=n>sys</span><span class=o>.</span><span class=n>executable</span><span class=p>}</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=n>numpy</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=p>{</span><span class=n>sys</span><span class=o>.</span><span class=n>executable</span><span class=p>}</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=n>matplotlib</span>
</span></span><span class=line><span class=cl><span class=err>!</span><span class=p>{</span><span class=n>sys</span><span class=o>.</span><span class=n>executable</span><span class=p>}</span> <span class=o>-</span><span class=n>m</span> <span class=n>pip</span> <span class=n>install</span> <span class=n>scikit</span><span class=o>-</span><span class=n>fem</span>
</span></span></code></pre></div><p>Let us consider a parameterized problem.
The NIRB two-grid method follows the same ideas as in the Snapshot Proper Orthogonal Decomposition (POD) algorithm and is decomposed in two parts:</p><ul><li>The &ldquo;offline part&rdquo; : First we compute a reduced basis (denoted $\Phi_i$) from several snapshots of the solution (for different parameter values in a parameter set $\mathcal{G}$),</li><li>The &ldquo;online part&rdquo; : then we project onto it the solution that we are looking for, with a new parameter value $\mu \in \mathcal{G}$. What differs from the Snapshot POD is the projection step. Instead of solving the projection of the model onto the reduced basis (known as the reduced problem), we are going to use a coarse solution (let&rsquo;s named it $u_H$) with the parameter value $\mu$. Since we employ a coarse mesh instead of a fine one, this step is much faster than the execusion of a usual high fidelity solver launched on a fine mesh. Our new approximation will then be given by:
$$ u_{new}=\underset{i=1}{\overset{N}{\sum}} (u_H(\mu), \Phi_i)\Phi_i(x),$$
where $(\cdot,\cdot)$ is the $L^2$ inner product.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># import packages</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>skfem</span>  <span class=c1># for Finite Element Method</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span>
</span></span></code></pre></div><h2 id=1-the-2d-driven-cavity-problem>1) The 2D-driven cavity problem:</h2><h1 id=heading></h1>$$\begin{align*}
&-\nu \Delta u + (u \cdot \nabla) u + \nabla p =0, \textrm{ in } \Omega,\\
& \nabla. u=0, \textrm{ in } \Omega,\\
& (u_1,u_2)=(1,0), \textrm{ on } \Omega_{up}:=\partial \Omega \cap \{y=1\},\\
& (u_1,u_2)=(0,0), \textrm{ on } \partial \Omega \backslash \Omega_{up},
\end{align*}$$$$\begin{equation*}
\nu (\nabla u^k, \nabla v) + ((u^{k-1} \cdot \nabla) u^k,v) - (p^k, \nabla \cdot v) - (q, \nabla \cdot u^k) + 10^{-10} (p^k, q) =0, \textrm{in } \Omega,
\end{equation*}$$<p>where $u^{k-1}$ is the previous step solution, and we iterate until a threshold is reached (until $\|u^{k}-u^{k-1}\| < \varepsilon $).
Here, with the term $ 10^{-10} (p^k, q) $, we impose the average of the pressure $\int_{\Omega} p^k $ to be equal to $0$. For more details on how we derive this formulation, visit the link : <a href=https://github.com/grosjean1/navierStokes target=_blank rel=noopener>https://github.com/grosjean1/navierStokes</a> (FEM.pdf).</p><p>We employ Taylor-Hood elements to get a proper solution (e.g. P2-P1 for the tuple velocity-pressure) and obtain the system $\mathbf{K} \mathbf{x} =\mathbf{f}$ to solve where $\mathbf{K}= \begin{pmatrix}
\mathbf{A} & -\mathbf{B}^T\\
-\mathbf{B} & 10^{-10} \mathbf{C}
\end{pmatrix}$, $\mathbf{x}$ stands for the tuple velocity-pressure $(u_1^k,u_2^k,p^k)$, and where the assembled matrix $\mathbf{A}$ corresponds to the bilinear part $ \nu (\nabla u^k, \nabla v) + ((u^{k-1} \cdot \nabla) u^k),v) $, the matrix $ B$ to the bilinear part $( p^k ,\nabla \cdot v)$ and $\mathbf{C}$ is the mass matrix applied to the pressure variable ($(\cdot,\cdot)$ represents either the $L^2$ inner-product onto the velocity space or onto the pressure space).</p><p>The dirichlet boundary conditions are imposed with a penalization method, called with scikit-FEM by the line:</p><p>solve(*condense(K,f, x=uvp, D=D)),</p><p>where x=uvp gives the values at the boundaries of the velocity and D refers to the boundary decomposition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># First we define a mesh for the unit square</span>
</span></span><span class=line><span class=cl><span class=n>mesh</span><span class=o>=</span> <span class=n>skfem</span><span class=o>.</span><span class=n>MeshTri</span><span class=p>()</span><span class=o>.</span><span class=n>refined</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>with_boundaries</span><span class=p>(</span>                                                                
</span></span><span class=line><span class=cl>        <span class=p>{</span>                                                                                                                                
</span></span><span class=line><span class=cl>            <span class=s2>&#34;left&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;right&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;down&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;up&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>     
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=p>}</span>                                                                                                                               
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh</span>
</span></span></code></pre></div><pre><code>&lt;skfem MeshTri1 object&gt;
  Number of elements: 2048
  Number of vertices: 1089
  Number of nodes: 1089
  Named boundaries [# facets]: left [32], bottom [32], right [32], top [32], down [32], up [32]
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./NIRB2grid_5_1.svg alt=svg loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;First step.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Assembling matrices</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem.assembly</span> <span class=kn>import</span> <span class=n>BilinearForm</span><span class=p>,</span> <span class=n>LinearForm</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem.helpers</span> <span class=kn>import</span> <span class=n>grad</span><span class=p>,</span> <span class=n>dot</span><span class=p>,</span><span class=n>div</span><span class=p>,</span><span class=n>ddot</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>laplace</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;gradula&#34;</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dot</span><span class=p>(</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>),</span> <span class=n>grad</span><span class=p>(</span><span class=n>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>vector_laplace</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># same as laplace but for u,v vectors </span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>w</span><span class=o>.</span><span class=n>nu</span><span class=o>*</span><span class=n>ddot</span><span class=p>(</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>),</span> <span class=n>grad</span><span class=p>(</span><span class=n>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mass</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u</span> <span class=o>*</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>divu</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>div</span><span class=p>(</span><span class=n>u</span><span class=p>)</span> <span class=o>*</span> <span class=n>v</span>
</span></span><span class=line><span class=cl><span class=n>divergence</span> <span class=o>=</span> <span class=n>divu</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=c1>#z=w.up*u.grad[0] + w.up * u.grad[1] #(u^(k-1). grad u^k). v</span>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>nonlinearterm</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>up_x</span><span class=p>,</span> <span class=n>up_y</span> <span class=o>=</span> <span class=n>w</span><span class=o>.</span><span class=n>up</span> 
</span></span><span class=line><span class=cl>    <span class=n>v_x</span><span class=p>,</span><span class=n>v_y</span><span class=o>=</span><span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>v</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>gradu</span><span class=o>=</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>gradxu_x</span><span class=o>=</span><span class=n>gradu</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>    <span class=n>gradxu_y</span><span class=o>=</span><span class=n>gradu</span><span class=p>[</span><span class=mi>0</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>gradyu_x</span><span class=o>=</span><span class=n>gradu</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>gradyu_y</span><span class=o>=</span><span class=n>gradu</span><span class=p>[</span><span class=mi>1</span><span class=p>,</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=p>(</span><span class=n>up_x</span><span class=o>*</span><span class=n>gradxu_x</span><span class=o>+</span><span class=n>up_y</span><span class=o>*</span><span class=n>gradxu_y</span><span class=p>)</span><span class=o>*</span><span class=n>v_x</span> <span class=o>+</span> <span class=p>(</span><span class=n>up_x</span><span class=o>*</span><span class=n>gradyu_x</span><span class=o>+</span><span class=n>up_y</span><span class=o>*</span><span class=n>gradyu_y</span><span class=p>)</span><span class=o>*</span><span class=n>v_y</span>
</span></span><span class=line><span class=cl>  
</span></span></code></pre></div><p>In the 2D-driven cavity problem, the parameter of interest is the Reynolds number. In the code bellow, the function SolveCavityProblem(Re,Mesh) takes as parameters the Reynolds number and a mesh, and returns the associated solution (velocity-pressure).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Finally we solve the problem &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=c1># Compute solution of the 2d-driven cavity problem</span>
</span></span><span class=line><span class=cl><span class=n>element</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;u&#39;</span><span class=p>:</span> <span class=n>ElementVector</span><span class=p>(</span><span class=n>ElementTriP2</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>           <span class=s1>&#39;p&#39;</span><span class=p>:</span> <span class=n>ElementTriP1</span><span class=p>()}</span> <span class=c1>#[u,v,p]= velocity-pressure with Taylor-Hood P2-P1 FEM elements</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>SolveCavityProblem</span><span class=p>(</span><span class=n>Re</span><span class=p>,</span><span class=n>Mesh</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Re is the reynolds parameter #</span>
</span></span><span class=line><span class=cl>    <span class=n>Nu</span><span class=o>=</span><span class=mf>1.</span><span class=o>/</span><span class=n>Re</span> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s1>&#39;Parameter nu:&#39;</span><span class=p>,</span><span class=n>Nu</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>basis</span> <span class=o>=</span> <span class=p>{</span><span class=n>variable</span><span class=p>:</span> <span class=n>Basis</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>intorder</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>         <span class=k>for</span> <span class=n>variable</span><span class=p>,</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>element</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span> <span class=c1># FEM space</span>
</span></span><span class=line><span class=cl>    <span class=n>up</span><span class=o>=</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>()</span> <span class=c1>#initialization for non-linear term previous solution</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>B</span> <span class=o>=</span><span class=n>divu</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span> <span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span> <span class=n>basis</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>])</span> <span class=c1># B.T=p*div(v) and B=q *div(u) with q=pressure test function</span>
</span></span><span class=line><span class=cl>    <span class=n>C</span> <span class=o>=</span> <span class=n>mass</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>],</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>]</span> <span class=p>)</span> <span class=c1># 1^-10 * p*q impose pressure average equal to 0.</span>
</span></span><span class=line><span class=cl>    <span class=n>A1</span> <span class=o>=</span><span class=n>vector_laplace</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span><span class=n>nu</span><span class=o>=</span><span class=n>Nu</span><span class=p>)</span> <span class=c1># nu* grad(u) * grad(v) with u=[u1,u2] and v is test function v=[v1,v2]</span>
</span></span><span class=line><span class=cl>    <span class=c1>#A2=nonlinearterm.assemble(basis[&#39;u&#39;],up=basis[&#39;u&#39;].interpolate(up)) #(u^(k-1). grad u^k). v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># global matrix Stokes</span>
</span></span><span class=line><span class=cl>    <span class=n>K</span> <span class=o>=</span> <span class=n>bmat</span><span class=p>([[</span><span class=n>A1</span><span class=p>,</span> <span class=o>-</span><span class=n>B</span><span class=o>.</span><span class=n>T</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=p>[</span><span class=o>-</span><span class=n>B</span><span class=p>,</span> <span class=mf>1e-10</span> <span class=o>*</span> <span class=n>C</span><span class=p>]],</span> <span class=s1>&#39;csr&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>profil_up</span><span class=p>(</span><span class=n>x</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=s2>&#34;&#34;&#34;return u=(0,1) at the up boundary and (0,0) otherwise &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>np</span><span class=o>.</span><span class=n>stack</span><span class=p>([</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>==</span><span class=mi>1</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>])])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>up_basis</span> <span class=o>=</span> <span class=n>FacetBasis</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>element</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span> <span class=n>facets</span><span class=o>=</span><span class=n>Mesh</span><span class=o>.</span><span class=n>boundaries</span><span class=p>[</span><span class=s1>&#39;up&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>all_basis</span> <span class=o>=</span> <span class=n>FacetBasis</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>element</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>uvp_boundary</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>hstack</span><span class=p>((</span>
</span></span><span class=line><span class=cl>        <span class=n>all_basis</span><span class=o>.</span><span class=n>project</span><span class=p>(</span><span class=n>profil_up</span><span class=p>),</span> <span class=c1># can be replaced by all_basis.project(profil_up), will be 0 by default for the other boundaries</span>
</span></span><span class=line><span class=cl>        <span class=n>basis</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>(),</span>
</span></span><span class=line><span class=cl>    <span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>D</span> <span class=o>=</span> <span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>get_dofs</span><span class=p>([</span><span class=s1>&#39;up&#39;</span><span class=p>,</span> <span class=s1>&#39;down&#39;</span><span class=p>,</span> <span class=s1>&#39;right&#39;</span><span class=p>,</span><span class=s1>&#39;left&#39;</span><span class=p>])</span> <span class=c1># since we put D on basis[&#39;u&#39;], there will be no penalization on pressure</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>([</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>(),</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;p&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>()])</span> <span class=c1># =0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>#######################</span>
</span></span><span class=line><span class=cl>    <span class=c1>### SOLVING PROBLEM ###</span>
</span></span><span class=line><span class=cl>    <span class=c1>#######################</span>
</span></span><span class=line><span class=cl>    <span class=n>uvp</span> <span class=o>=</span> <span class=n>solve</span><span class=p>(</span><span class=o>*</span><span class=n>condense</span><span class=p>(</span><span class=n>K</span><span class=p>,</span><span class=n>f</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=n>uvp_boundary</span><span class=p>,</span> <span class=n>D</span><span class=o>=</span><span class=n>D</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>velocity</span><span class=p>,</span> <span class=n>pressure</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>uvp</span><span class=p>,</span> <span class=n>K</span><span class=o>.</span><span class=n>blocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>15</span><span class=p>):</span> <span class=c1>#fixed-point iterations</span>
</span></span><span class=line><span class=cl>        <span class=n>up</span><span class=o>=</span><span class=n>velocity</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span> <span class=c1># updating velocity</span>
</span></span><span class=line><span class=cl>        <span class=n>A2</span><span class=o>=</span><span class=n>nonlinearterm</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span><span class=n>up</span><span class=o>=</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>interpolate</span><span class=p>(</span><span class=n>up</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>        <span class=c1># global matrix assembling update</span>
</span></span><span class=line><span class=cl>        <span class=n>K</span> <span class=o>=</span> <span class=n>bmat</span><span class=p>([[</span><span class=n>A1</span><span class=o>+</span><span class=n>A2</span><span class=p>,</span> <span class=o>-</span><span class=n>B</span><span class=o>.</span><span class=n>T</span><span class=p>],</span>
</span></span><span class=line><span class=cl>          <span class=p>[</span><span class=o>-</span><span class=n>B</span><span class=p>,</span> <span class=mf>1e-10</span> <span class=o>*</span> <span class=n>C</span><span class=p>]],</span> <span class=s1>&#39;csr&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>uvp</span> <span class=o>=</span> <span class=n>solve</span><span class=p>(</span><span class=o>*</span><span class=n>condense</span><span class=p>(</span><span class=n>K</span><span class=p>,</span><span class=n>f</span><span class=p>,</span> <span class=n>x</span><span class=o>=</span><span class=n>uvp_boundary</span><span class=p>,</span> <span class=n>D</span><span class=o>=</span><span class=n>D</span><span class=p>))</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>        <span class=n>velocity</span><span class=p>,</span> <span class=n>pressure</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>split</span><span class=p>(</span><span class=n>uvp</span><span class=p>,</span> <span class=n>K</span><span class=o>.</span><span class=n>blocks</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span>
</span></span><span class=line><span class=cl>    
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; We may visualize the solutions &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem.visuals.matplotlib</span> <span class=kn>import</span> <span class=n>plot</span><span class=p>,</span> <span class=n>draw</span><span class=p>,</span> <span class=n>savefig</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span><span class=o>=</span><span class=n>SolveCavityProblem</span><span class=p>(</span><span class=mi>150</span><span class=p>,</span><span class=n>mesh</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>visualize_pressure</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span><span class=n>Pressure</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1>## Function that allows us to visualize the pressure</span>
</span></span><span class=line><span class=cl>    <span class=c1>#from skfem.visuals.matplotlib import plot</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plot</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>Pressure</span><span class=p>,</span> <span class=n>shading</span><span class=o>=</span><span class=s1>&#39;gouraud&#39;</span><span class=p>,</span> <span class=n>colorbar</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>visualize_pressure</span><span class=p>(</span><span class=n>mesh</span><span class=p>,</span><span class=n>pressure</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>visualize_velocity</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span><span class=n>Velocity</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1>## Function that allows us to visualize the velocity</span>
</span></span><span class=line><span class=cl>    <span class=n>fig</span><span class=p>,</span> <span class=n>ax</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>subplots</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Calculate the magnitude of velocity</span>
</span></span><span class=line><span class=cl>    <span class=n>basis</span> <span class=o>=</span> <span class=p>{</span><span class=n>variable</span><span class=p>:</span> <span class=n>Basis</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>intorder</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>variable</span><span class=p>,</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>element</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span> <span class=c1># FEM space</span>
</span></span><span class=line><span class=cl>    <span class=n>velocity1</span> <span class=o>=</span> <span class=n>Velocity</span><span class=p>[</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>nodal_dofs</span><span class=p>]</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>magnitude</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>velocity1</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span> <span class=o>+</span> <span class=n>velocity1</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Display the velocity fields with colors for magnitude</span>
</span></span><span class=line><span class=cl>    <span class=n>quiver</span> <span class=o>=</span> <span class=n>ax</span><span class=o>.</span><span class=n>quiver</span><span class=p>(</span><span class=o>*</span><span class=n>mesh</span><span class=o>.</span><span class=n>p</span><span class=p>,</span> <span class=o>*</span><span class=n>velocity1</span><span class=p>,</span> <span class=n>magnitude</span><span class=p>,</span> <span class=n>angles</span><span class=o>=</span><span class=s1>&#39;xy&#39;</span><span class=p>,</span> <span class=n>cmap</span><span class=o>=</span><span class=s1>&#39;jet&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># colorbar</span>
</span></span><span class=line><span class=cl>    <span class=n>cbar</span> <span class=o>=</span> <span class=n>plt</span><span class=o>.</span><span class=n>colorbar</span><span class=p>(</span><span class=n>quiver</span><span class=p>,</span> <span class=n>ax</span><span class=o>=</span><span class=n>ax</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Limits of axis for the mesh</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_xlim</span><span class=p>([</span><span class=n>Mesh</span><span class=o>.</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>Mesh</span><span class=o>.</span><span class=n>p</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>    <span class=n>ax</span><span class=o>.</span><span class=n>set_ylim</span><span class=p>([</span><span class=n>Mesh</span><span class=o>.</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>min</span><span class=p>(),</span> <span class=n>Mesh</span><span class=o>.</span><span class=n>p</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>.</span><span class=n>max</span><span class=p>()])</span>
</span></span><span class=line><span class=cl>    <span class=n>cbar</span><span class=o>.</span><span class=n>set_label</span><span class=p>(</span><span class=s1>&#39;Velocity magnitude&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># show results</span>
</span></span><span class=line><span class=cl>    <span class=n>plt</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>visualize_velocity</span><span class=p>(</span><span class=n>mesh</span><span class=p>,</span><span class=n>velocity</span><span class=p>)</span>
</span></span></code></pre></div><pre><code>Parameter nu: 0.006666666666666667
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./NIRB2grid_9_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./NIRB2grid_9_2.png alt=png loading=lazy data-zoomable></div></div></figure></p><h3 id=nirb-two-grid-method>NIRB two-grid method</h3><p>We are now able to proceed with the offline and online parts of the NIRB two-grid method.
We will apply the NIRB method on the velocity but it works the same for the pressure.</p><h4 id=offline-part>OFFLINE PART</h4><p>We define the two meshes: one with a fine size (which will be used to generate the reduced basis) and one with a coarser size (used during the online step to enhance the run-times).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## FINE MESH</span>
</span></span><span class=line><span class=cl><span class=n>FineMesh</span> <span class=o>=</span> <span class=n>skfem</span><span class=o>.</span><span class=n>MeshTri</span><span class=p>()</span><span class=o>.</span><span class=n>refined</span><span class=p>(</span><span class=mi>5</span><span class=p>)</span><span class=o>.</span><span class=n>with_boundaries</span><span class=p>(</span>                                                                
</span></span><span class=line><span class=cl>        <span class=p>{</span>                                                                                                                                
</span></span><span class=line><span class=cl>            <span class=s2>&#34;left&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;right&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;down&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;up&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>     
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=p>}</span>                                                                                                                               
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>FineBasis</span> <span class=o>=</span> <span class=p>{</span><span class=n>variable</span><span class=p>:</span> <span class=n>Basis</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>intorder</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>variable</span><span class=p>,</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>element</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span> <span class=c1># FEM space</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NumberOfNodesFineMesh</span> <span class=o>=</span> <span class=n>FineMesh</span><span class=o>.</span><span class=n>p</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;number of fine nodes: &#34;</span><span class=p>,</span><span class=n>NumberOfNodesFineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#num_dofs_uFineMesh = basis[&#39;u&#39;].doflocs.shape[1] # or np.shape(velocity)[0] for DOFs</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## COARSER MESH</span>
</span></span><span class=line><span class=cl><span class=n>CoarseMesh</span><span class=o>=</span> <span class=n>skfem</span><span class=o>.</span><span class=n>MeshTri</span><span class=p>()</span><span class=o>.</span><span class=n>refined</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=o>.</span><span class=n>with_boundaries</span><span class=p>(</span>                                                                
</span></span><span class=line><span class=cl>        <span class=p>{</span>                                                                                                                                
</span></span><span class=line><span class=cl>            <span class=s2>&#34;left&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;right&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;down&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;up&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>        
</span></span><span class=line><span class=cl>        <span class=p>}</span>                                                                                                                               
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CoarseBasis</span> <span class=o>=</span> <span class=p>{</span><span class=n>variable</span><span class=p>:</span> <span class=n>Basis</span><span class=p>(</span><span class=n>CoarseMesh</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>intorder</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>variable</span><span class=p>,</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>element</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span> <span class=c1># FEM space</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NumberOfNodesCoarseMesh</span> <span class=o>=</span> <span class=n>CoarseMesh</span><span class=o>.</span><span class=n>p</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;number of coarse nodes: &#34;</span><span class=p>,</span><span class=n>NumberOfNodesCoarseMesh</span> <span class=p>)</span>
</span></span></code></pre></div><pre><code>number of nodes:  1089
number of nodes:  81
</code></pre><p>Now we may proceed with the POD algorithm (but any other method that constructs an adequate basis for the solution manifold could be used, e.g. such as a greedy approach). We decompose the snapshots by one average over the parameters and by one fluctuation part. Then, the POD modes are estimated with the fluctuations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; POD (can be replaced by a greedy approach) &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; POD &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;        Offline                    &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NumberOfSnapshots</span><span class=o>=</span><span class=mi>10</span> <span class=c1>#Training set</span>
</span></span><span class=line><span class=cl><span class=n>NumberOfModes</span><span class=o>=</span><span class=mi>6</span> <span class=c1>#tol</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;number of modes: &#34;</span><span class=p>,</span><span class=n>NumberOfModes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#####  Create fluctuation parts for the snapshots #####</span>
</span></span><span class=line><span class=cl><span class=n>Re</span><span class=o>=</span><span class=mf>1.</span> <span class=c1>#first Reynolds number</span>
</span></span><span class=line><span class=cl><span class=n>AveragedSnapshots</span><span class=o>=</span><span class=n>FineBasis</span><span class=p>[</span><span class=s2>&#34;u&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineSnapshots</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span><span class=o>=</span><span class=n>SolveCavityProblem</span><span class=p>(</span><span class=n>Re</span><span class=p>,</span><span class=n>FineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>Re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#visualize_velocity(mesh,velocity)</span>
</span></span><span class=line><span class=cl>    <span class=n>AveragedSnapshots</span><span class=o>+=</span><span class=n>velocity</span>
</span></span><span class=line><span class=cl>    <span class=n>FineSnapshots</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>velocity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Re</span><span class=o>+=</span><span class=mi>45</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;last Reynolds:&#34;</span><span class=p>,</span><span class=n>Re</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>AveragedSnapshots</span><span class=o>/=</span><span class=n>NumberOfSnapshots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>FineSnapshots</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-=</span><span class=n>AveragedSnapshots</span>
</span></span><span class=line><span class=cl>    <span class=c1>#visualize_velocity(FineMesh,FineSnapshots[i])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## SVD ##</span>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>massVelocity</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=n>u</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>v</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>L2</span><span class=o>=</span><span class=n>massVelocity</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s2>&#34;u&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># We first compute the correlation matrix C_ij = (u_i,u_j)</span>
</span></span><span class=line><span class=cl><span class=n>CorrelationMatrix</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>NumberOfSnapshots</span><span class=p>,</span> <span class=n>NumberOfSnapshots</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>snapshot1</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>MatVecProduct</span> <span class=o>=</span> <span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>snapshot1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span><span class=p>,</span> <span class=n>snapshot2</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=n>i</span> <span class=o>&gt;=</span> <span class=n>j</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>CorrelationMatrix</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>MatVecProduct</span><span class=p>,</span> <span class=n>snapshot2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=n>CorrelationMatrix</span><span class=p>[</span><span class=n>j</span><span class=p>,</span> <span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=n>CorrelationMatrix</span><span class=p>[</span><span class=n>i</span><span class=p>,</span> <span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#print(&#34;CorrelationMatrix&#34;,CorrelationMatrix)</span>
</span></span><span class=line><span class=cl><span class=c1># Then, we compute the eigenvalues/eigenvectors of C </span>
</span></span><span class=line><span class=cl><span class=n>EigenValues</span><span class=p>,</span> <span class=n>EigenVectors</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>eigh</span><span class=p>(</span><span class=n>CorrelationMatrix</span><span class=p>,</span> <span class=n>UPLO</span><span class=o>=</span><span class=s2>&#34;L&#34;</span><span class=p>)</span> <span class=c1>#SVD: C eigenVectors=eigenValues eigenVectors</span>
</span></span><span class=line><span class=cl><span class=n>idx</span> <span class=o>=</span> <span class=n>EigenValues</span><span class=o>.</span><span class=n>argsort</span><span class=p>()[::</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> <span class=c1># sort the eigenvalues</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TotEigenValues</span> <span class=o>=</span> <span class=n>EigenValues</span><span class=p>[</span><span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>TotEigenVectors</span> <span class=o>=</span> <span class=n>EigenVectors</span><span class=p>[:,</span> <span class=n>idx</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>EigenValues</span><span class=o>=</span><span class=n>TotEigenValues</span><span class=p>[</span><span class=mi>0</span><span class=p>:</span><span class=n>NumberOfModes</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>EigenVectors</span><span class=o>=</span><span class=n>TotEigenVectors</span><span class=p>[:,</span><span class=mi>0</span><span class=p>:</span><span class=n>NumberOfModes</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;eigenvalues: &#34;</span><span class=p>,</span><span class=n>EigenValues</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>RIC</span><span class=o>=</span><span class=mi>1</span><span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>EigenValues</span><span class=p>)</span><span class=o>/</span><span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>TotEigenValues</span><span class=p>)</span> <span class=c1>#must be close to 0</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Relativ Information Content (must be close to 0):&#34;</span><span class=p>,</span><span class=n>RIC</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>RIClist</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>EigenValues</span><span class=p>)):</span>
</span></span><span class=line><span class=cl>    <span class=n>RIClist</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=mi>1</span><span class=o>-</span><span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>EigenValues</span><span class=p>[:</span><span class=n>i</span><span class=p>])</span><span class=o>/</span><span class=n>np</span><span class=o>.</span><span class=n>sum</span><span class=p>(</span><span class=n>TotEigenValues</span><span class=p>))</span> <span class=c1>#must be close to 0</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ChangeOfBasisMatrix</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>NumberOfModes</span><span class=p>,</span><span class=n>NumberOfSnapshots</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>ChangeOfBasisMatrix</span><span class=p>[</span><span class=n>j</span><span class=p>,:]</span> <span class=o>=</span> <span class=n>EigenVectors</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>/</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>EigenValues</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ReducedBasis</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>ChangeOfBasisMatrix</span><span class=p>,</span><span class=n>FineSnapshots</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#visualize_velocity(mesh,ReducedBasis[2])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># orthogonality test</span>
</span></span><span class=line><span class=cl><span class=c1>#for i in range(NumberOfModes):</span>
</span></span><span class=line><span class=cl><span class=c1>#    MatVecProduct = L2.dot(ReducedBasis[i])</span>
</span></span><span class=line><span class=cl><span class=c1>#    for j in range(NumberOfModes):    </span>
</span></span><span class=line><span class=cl><span class=c1>#        test = np.dot(MatVecProduct, ReducedBasis[j])</span>
</span></span><span class=line><span class=cl><span class=c1>#        print(&#34;orthogonal:&#34;,test)</span>
</span></span></code></pre></div><pre><code>-----------------------------------
        Offline                    
-----------------------------------
number of modes:  6
Parameter nu: 1.0
1.0
Parameter nu: 0.021739130434782608
46.0
Parameter nu: 0.01098901098901099
91.0
Parameter nu: 0.007352941176470588
136.0
Parameter nu: 0.0055248618784530384
181.0
Parameter nu: 0.004424778761061947
226.0
Parameter nu: 0.0036900369003690036
271.0
Parameter nu: 0.0031645569620253164
316.0
Parameter nu: 0.002770083102493075
361.0
Parameter nu: 0.0024630541871921183
406.0
last Reynolds: 451.0
eigenvalues:  [2.54755393e-02 3.20763587e-03 2.74529238e-04 2.30847869e-05
 2.67682655e-06 1.94549831e-07]
Relativ Information Content (must be close to 0): 2.7825776416356973e-07
</code></pre><p>A greedy algorithm is a procedure which aims at approximating each element of a compact set (here the manifold $S_h=Span\{u_h^0, \dots,u_h^n, \}$) in a Hilbert space $V_h$ by a subspace of properly selected elements of this compact set. The greedy procedure is a fast way to compute the modes by choosing some suitable parameters with respect to a criterion. At each Greedy iteration, the new RB parameter is chosen such that the corresponding snapshot is the worse approached by the previous basis space. In general, this strategy does not produce an optimal solution but yields to more accurate approximation with the rectification post-treatment.
We have seen that the projection of a solution onto the reduced basis is given by $P^n(u)=\underset{i=1}{\overset{n}{\sum}} (u,\Phi_i)\Phi_i$.</p><ul><li><p>During the greedy algorithm, we first set $\Phi_0:=\frac{u_h^0}{\|u_h^0\|}$ (or any snapshots in the training set).</p></li><li><p>Then, we look for another snapshot $u_h^k$ in the training set that maximizes the error between itself and its projection onto the reduced basis, built from the first snapshot: $\frac{\|u_h^k - P^0(u_h^k) \|}{\|u_h^k\|}$, and we set $\Phi_1= \frac{u_h^k - P^0(u_h^k)}{\|u_h^k - P^0(u_h^k)\|}$.</p></li><li><p>We iterate until obtaining a tolerance threshold on this error maximization.</p></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Greedy approach  &#34;&#34;&#34;</span> <span class=c1>#(instead of POD)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34; STEP1: Offline                    &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>NumberOfSnapshots</span><span class=o>=</span><span class=mi>10</span>
</span></span><span class=line><span class=cl><span class=n>NumberOfModes</span><span class=o>=</span><span class=mi>6</span>
</span></span><span class=line><span class=cl><span class=c1>#tol=1e-6</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;number of modes: &#34;</span><span class=p>,</span><span class=n>NumberOfModes</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#####  Create fluctuation parts for the snapshots #####</span>
</span></span><span class=line><span class=cl><span class=n>Re</span><span class=o>=</span><span class=mf>1.</span> <span class=c1>#first Reynolds number</span>
</span></span><span class=line><span class=cl><span class=n>AveragedSnapshots</span><span class=o>=</span><span class=n>FineBasis</span><span class=p>[</span><span class=s2>&#34;u&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineSnapshots</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span><span class=o>=</span><span class=n>SolveCavityProblem</span><span class=p>(</span><span class=n>Re</span><span class=p>,</span><span class=n>FineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>Re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#visualize_velocity(mesh,velocity)</span>
</span></span><span class=line><span class=cl>    <span class=n>AveragedSnapshots</span><span class=o>+=</span><span class=n>velocity</span>
</span></span><span class=line><span class=cl>    <span class=n>FineSnapshots</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>velocity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Re</span><span class=o>+=</span><span class=mi>45</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;last Reynolds:&#34;</span><span class=p>,</span><span class=n>Re</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>AveragedSnapshots</span><span class=o>/=</span><span class=n>NumberOfSnapshots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>FineSnapshots</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-=</span><span class=n>AveragedSnapshots</span>
</span></span><span class=line><span class=cl>    <span class=c1>#visualize_velocity(FineMesh,FineSnapshots[i])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## SVD ##</span>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>massVelocity</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>*</span> <span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>+</span><span class=n>u</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>*</span> <span class=n>v</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>L2</span><span class=o>=</span><span class=n>massVelocity</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s2>&#34;u&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=c1># We first compute the correlation matrix C_ij = (u_i,u_j)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ReducedBasis</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>NumberOfModes</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>velocity</span><span class=p>)[</span><span class=mi>0</span><span class=p>]))</span>
</span></span><span class=line><span class=cl><span class=n>SnapshotNorm</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=mi>0</span><span class=p>])))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ReducedBasis</span><span class=p>[</span><span class=mi>0</span><span class=p>,:]</span><span class=o>=</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>/</span><span class=n>SnapshotNorm</span> <span class=c1>#first mode</span>
</span></span><span class=line><span class=cl><span class=n>ListReducedOrderBasis</span><span class=o>=</span><span class=p>[</span><span class=n>ReducedBasis</span><span class=p>[</span><span class=mi>0</span><span class=p>,:]]</span>
</span></span><span class=line><span class=cl><span class=n>ListeIndex</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=c1>#first snapshot </span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>MatrixBasisProduct</span><span class=o>=</span><span class=p>[</span><span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>ListReducedOrderBasis</span><span class=p>[</span><span class=mi>0</span><span class=p>])]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>n</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=n>NumberOfModes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>TestVector</span><span class=o>=</span><span class=nb>dict</span><span class=p>()</span> <span class=c1># dictionnary: vector in the reduced basis if maxTest if maximum</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span> 
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=ow>not</span> <span class=p>(</span><span class=n>j</span> <span class=ow>in</span> <span class=n>ListeIndex</span><span class=p>):</span> <span class=c1>#if index not yet in the basis </span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>            <span class=c1>#w= u_j - sum_k (u_j,Phi_k) Phi_k</span>
</span></span><span class=line><span class=cl>            <span class=n>w</span><span class=o>=</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=nb>sum</span><span class=p>((</span><span class=n>bk</span><span class=o>*</span><span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>MatrixBasisProduct</span><span class=p>[</span><span class=n>k</span><span class=p>],</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>j</span><span class=p>])</span> <span class=k>for</span> <span class=n>k</span><span class=p>,</span><span class=n>bk</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>ListReducedOrderBasis</span><span class=p>)))</span><span class=c1>#,axis=0)#potential vector to add in the reduced basis</span>
</span></span><span class=line><span class=cl>                
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>NormL2W</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>((</span><span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>w</span><span class=p>)),</span><span class=n>w</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>j</span><span class=p>],</span><span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>j</span><span class=p>])))</span> <span class=o>&gt;</span> <span class=mf>1e-10</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>GreedyMaximumTest</span><span class=o>=</span><span class=n>NormL2W</span><span class=o>/</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>j</span><span class=p>],</span><span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>j</span><span class=p>])))</span> <span class=c1>#we seek the max</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                <span class=n>GreedyMaximumTest</span><span class=o>=</span><span class=n>NormL2W</span> <span class=c1>#we seek the max</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=n>TestVector</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=p>[</span><span class=n>GreedyMaximumTest</span><span class=p>,</span><span class=n>w</span><span class=p>,</span><span class=n>NormL2W</span><span class=p>]</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>    <span class=n>Index</span><span class=o>=</span><span class=nb>max</span><span class=p>(</span><span class=n>TestVector</span><span class=p>,</span> <span class=n>key</span> <span class=o>=</span> <span class=k>lambda</span> <span class=n>k</span><span class=p>:</span> <span class=n>TestVector</span><span class=p>[</span><span class=n>k</span><span class=p>][</span><span class=mi>0</span><span class=p>])</span> <span class=c1>#index of the snapshot used</span>
</span></span><span class=line><span class=cl>    <span class=n>ListeIndex</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>Index</span><span class=p>)</span> <span class=c1>#adding the corresponding j in the list</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>ListReducedOrderBasis</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>TestVector</span><span class=p>[</span><span class=n>Index</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>/</span><span class=n>TestVector</span><span class=p>[</span><span class=n>Index</span><span class=p>][</span><span class=mi>2</span><span class=p>])</span><span class=c1>#orthonormalization in L2</span>
</span></span><span class=line><span class=cl>    <span class=n>MatrixBasisProduct</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>L2</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>ListReducedOrderBasis</span><span class=p>[</span><span class=n>n</span><span class=p>]))</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>    <span class=n>ReducedBasis</span><span class=p>[</span><span class=n>n</span><span class=p>,:]</span><span class=o>=</span><span class=n>ListReducedOrderBasis</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>]</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#print(np.dot(L2.dot(ReducedBasis[0,:]),ReducedBasis[1,:]))</span>
</span></span></code></pre></div><pre><code>-----------------------------------
 STEP1: Offline                    
-----------------------------------
number of modes:  6
Parameter nu: 1.0
1.0
Parameter nu: 0.021739130434782608
46.0
Parameter nu: 0.01098901098901099
91.0
Parameter nu: 0.007352941176470588
136.0
Parameter nu: 0.0055248618784530384
181.0
Parameter nu: 0.004424778761061947
226.0
Parameter nu: 0.0036900369003690036
271.0
Parameter nu: 0.0031645569620253164
316.0
Parameter nu: 0.002770083102493075
361.0
Parameter nu: 0.0024630541871921183
406.0
last Reynolds: 451.0
</code></pre><p>Now that we have our reduced basis, we complete the offline part with the rectification post-treatment (see details in the NIRB 2-grid section):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;---- RECTIFICATION POST-TREATMENT -&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># We need several coarse snapshots</span>
</span></span><span class=line><span class=cl><span class=c1># Compute solution of the 2d-driven cavity problem on a coarser mesh</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Re</span><span class=o>=</span><span class=mf>1.</span>
</span></span><span class=line><span class=cl><span class=n>AveragedCoarseSnapshots</span><span class=o>=</span><span class=n>CoarseBasis</span><span class=p>[</span><span class=s2>&#34;u&#34;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>CoarseSnapshots</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>Re</span><span class=o>=</span><span class=mf>1.</span> <span class=c1>#first Reynolds number</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span><span class=o>=</span><span class=n>SolveCavityProblem</span><span class=p>(</span><span class=n>Re</span><span class=p>,</span><span class=n>CoarseMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>Re</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1>#visualize_velocity(mesh,velocity)</span>
</span></span><span class=line><span class=cl>    <span class=n>AveragedCoarseSnapshots</span><span class=o>+=</span><span class=n>velocity</span>
</span></span><span class=line><span class=cl>    <span class=n>CoarseSnapshots</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>velocity</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>Re</span><span class=o>+=</span><span class=mi>45</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;last Reynolds:&#34;</span><span class=p>,</span><span class=n>Re</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>AveragedCoarseSnapshots</span><span class=o>/=</span><span class=n>NumberOfSnapshots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>CoarseSnapshots</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>-=</span><span class=n>AveragedCoarseSnapshots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Interpolation of coarse solutions on the fine mesh to do the inner product with the reduced basis</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>scipy.spatial</span> <span class=kn>import</span> <span class=n>cKDTree</span>
</span></span><span class=line><span class=cl><span class=n>InterpolatedCoarseSnapshots</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>snapshotH</span> <span class=o>=</span><span class=n>CoarseSnapshots</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=c1># Nearest interpolation</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># Use of cKDTree to interpolate to the nearest neighbor</span>
</span></span><span class=line><span class=cl>    <span class=n>tree</span> <span class=o>=</span> <span class=n>cKDTree</span><span class=p>(</span><span class=n>CoarseBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>doflocs</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>  <span class=c1># Find the nodes of the degree of freedom of the coarse solution </span>
</span></span><span class=line><span class=cl>    <span class=n>distances</span><span class=p>,</span> <span class=n>indices</span> <span class=o>=</span> <span class=n>tree</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>doflocs</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>  <span class=c1># Find the nearest nodes on the fine grid</span>
</span></span><span class=line><span class=cl> 
</span></span><span class=line><span class=cl>    <span class=n>u_interpolated</span> <span class=o>=</span> <span class=n>snapshotH</span><span class=p>[</span><span class=n>indices</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>InterpolatedCoarseSnapshots</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>u_interpolated</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>alpha</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>NumberOfSnapshots</span><span class=p>,</span><span class=n>NumberOfModes</span><span class=p>))</span> <span class=c1># Fine coefficients</span>
</span></span><span class=line><span class=cl><span class=n>beta</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>NumberOfSnapshots</span><span class=p>,</span><span class=n>NumberOfModes</span><span class=p>))</span> <span class=c1># Coarse coefficients</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfSnapshots</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>alpha</span><span class=p>[</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ReducedBasis</span><span class=p>[</span><span class=n>j</span><span class=p>,:])</span>
</span></span><span class=line><span class=cl>        <span class=n>beta</span><span class=p>[</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>InterpolatedCoarseSnapshots</span><span class=p>[</span><span class=n>i</span><span class=p>])</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ReducedBasis</span><span class=p>[</span><span class=n>j</span><span class=p>,:])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lambd</span><span class=o>=</span><span class=mf>1e-12</span> <span class=c1>#Regularization Tikhonov parameter (AT@A +lambda I_d)^-1</span>
</span></span><span class=line><span class=cl><span class=n>R</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>NumberOfModes</span><span class=p>,</span><span class=n>NumberOfModes</span><span class=p>))</span> <span class=c1># rectification matrix</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>,:]</span><span class=o>=</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>inv</span><span class=p>(</span><span class=n>beta</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span><span class=nd>@beta</span><span class=o>+</span><span class=n>lambd</span><span class=o>*</span><span class=n>np</span><span class=o>.</span><span class=n>eye</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>))</span><span class=nd>@beta.transpose</span><span class=p>()</span><span class=nd>@alpha</span><span class=p>[:,</span><span class=n>i</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#print(&#34;rectification matrix &#34;, R)</span>
</span></span></code></pre></div><pre><code>-----------------------------------
---- RECTIFICATION POST-TREATMENT -
-----------------------------------
Parameter nu: 1.0
1.0
Parameter nu: 0.021739130434782608
46.0
Parameter nu: 0.01098901098901099
91.0
Parameter nu: 0.007352941176470588
136.0
Parameter nu: 0.0055248618784530384
181.0
Parameter nu: 0.004424778761061947
226.0
Parameter nu: 0.0036900369003690036
271.0
Parameter nu: 0.0031645569620253164
316.0
Parameter nu: 0.002770083102493075
361.0
Parameter nu: 0.0024630541871921183
406.0
last Reynolds: 451.0
</code></pre><p>Now we can check for our reduced basis accuracy.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  Reduced basis accuracy           &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>### Offline Errors</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Offline Errors&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>CompressionErrors</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>H1compressionErrors</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#snap,pressure=SolveCavityProblem(1,FineMesh)</span>
</span></span><span class=line><span class=cl><span class=n>H10</span><span class=o>=</span><span class=n>vector_laplace</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span><span class=n>nu</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>snap</span> <span class=ow>in</span> <span class=n>FineSnapshots</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>ExactSolution</span> <span class=o>=</span><span class=n>snap</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    <span class=n>CompressedSolutionU</span><span class=o>=</span> <span class=n>ExactSolution</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ReducedBasis.transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    <span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>CompressedSolutionU</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=p>)</span> <span class=c1>#pas de tps 0</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>norml2ExactSolution</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ExactSolution</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ExactSolution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>normh1ExactSolution</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ExactSolution</span><span class=o>@</span><span class=p>(</span><span class=n>H10</span><span class=nd>@ExactSolution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>=</span><span class=n>ReconstructedCompressedSolution</span><span class=o>-</span><span class=n>ExactSolution</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>norml2ExactSolution</span> <span class=o>!=</span><span class=mi>0</span> <span class=ow>and</span> <span class=n>normh1ExactSolution</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>relError</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=nd>@L2@t</span><span class=p>)</span><span class=o>/</span><span class=n>norml2ExactSolution</span>
</span></span><span class=line><span class=cl>        <span class=n>relh1Error</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=nd>@H10@t</span><span class=p>)</span><span class=o>/</span><span class=n>normh1ExactSolution</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>relError</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>norm</span><span class=p>(</span><span class=n>ReconstructedCompressedSolution</span><span class=o>-</span><span class=n>ExactSolution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>CompressionErrors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>relError</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>H1compressionErrors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>relh1Error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;L2 compression error =&#34;</span><span class=p>,</span> <span class=n>CompressionErrors</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;H1 compression error =&#34;</span><span class=p>,</span> <span class=n>H1compressionErrors</span><span class=p>)</span>
</span></span></code></pre></div><pre><code>-----------------------------------
  Reduced basis accuracy           
-----------------------------------
Offline Errors
L2 compression error = [5.491498134937185e-15, 2.538313760278743e-15, 0.005047680588374, 6.856034389920962e-15, 8.453759485141844e-15, 3.9049158686965763e-14, 0.0020752097057184925, 0.0023026771887077963, 0.001300456504031845, 4.306568104312849e-14]
H1 compression error = [8.150120550679852e-15, 3.1926038636758358e-15, 0.007551053558987375, 1.1597328204733784e-14, 1.1403564181195185e-14, 5.922423559212762e-14, 0.0031117393782900357, 0.003318676996131936, 0.00183471957047579, 6.15532382843519e-14]
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;     ONLINE PART          !!!      &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>### Online Errors</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Online Errors&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Ret</span><span class=o>=</span><span class=mi>110</span> <span class=c1>##Targeted parameter</span>
</span></span><span class=line><span class=cl><span class=n>H10</span><span class=o>=</span><span class=n>vector_laplace</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span><span class=n>nu</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span><span class=o>=</span><span class=n>SolveCavityProblem</span><span class=p>(</span><span class=n>Ret</span><span class=p>,</span><span class=n>CoarseMesh</span><span class=p>)</span> <span class=c1>##Targeted parameter</span>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=o>-=</span><span class=n>AveragedCoarseSnapshots</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>## Interpolation of coarse solutions on the fine mesh to do the inner product with the reduced basis</span>
</span></span><span class=line><span class=cl><span class=n>snapshotH</span> <span class=o>=</span><span class=n>velocity</span>
</span></span><span class=line><span class=cl><span class=c1># Nearest interpolation</span>
</span></span><span class=line><span class=cl><span class=c1># Use of cKDTree to interpolate to the nearest neighbor</span>
</span></span><span class=line><span class=cl><span class=n>tree</span> <span class=o>=</span> <span class=n>cKDTree</span><span class=p>(</span><span class=n>CoarseBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>doflocs</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>  <span class=c1># Find the nodes of the degree of freedom of the coarse solution </span>
</span></span><span class=line><span class=cl><span class=n>distances</span><span class=p>,</span> <span class=n>indices</span> <span class=o>=</span> <span class=n>tree</span><span class=o>.</span><span class=n>query</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>doflocs</span><span class=o>.</span><span class=n>T</span><span class=p>)</span>  <span class=c1># Find the nearest nodes on the fine grid</span>
</span></span><span class=line><span class=cl><span class=n>u_interpolated</span> <span class=o>=</span> <span class=n>snapshotH</span><span class=p>[</span><span class=n>indices</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>InterpolatedCoarseSnapshot</span><span class=o>=</span><span class=n>u_interpolated</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=p>,</span><span class=n>pressure</span><span class=o>=</span><span class=n>SolveCavityProblem</span><span class=p>(</span><span class=n>Ret</span><span class=p>,</span><span class=n>FineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=o>-=</span><span class=n>AveragedSnapshots</span>
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span> <span class=o>=</span><span class=n>velocity</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span><span class=o>=</span> <span class=n>InterpolatedCoarseSnapshot</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ReducedBasis.transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>coef</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>coef</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>coef</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>+=</span><span class=n>R</span><span class=p>[</span><span class=n>i</span><span class=p>,</span><span class=n>j</span><span class=p>]</span><span class=o>*</span><span class=n>CompressedSolutionU</span><span class=p>[</span><span class=n>j</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#RectifiedSolutionU=np.dot(R,CompressedSolutionU)</span>
</span></span><span class=line><span class=cl><span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>coef</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=n>norml2ExactSolution</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ExactSolution</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ExactSolution</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>normh1ExactSolution</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ExactSolution</span><span class=o>@</span><span class=p>(</span><span class=n>H10</span><span class=nd>@ExactSolution</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>t</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>ReconstructedCompressedSolution</span><span class=o>-</span><span class=n>ExactSolution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=n>norml2ExactSolution</span> <span class=o>!=</span><span class=mi>0</span> <span class=ow>and</span> <span class=n>normh1ExactSolution</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=n>relError</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=nd>@L2@t</span><span class=p>)</span><span class=o>/</span><span class=n>norml2ExactSolution</span>
</span></span><span class=line><span class=cl>    <span class=n>relh1Error</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=nd>@H10@t</span><span class=p>)</span><span class=o>/</span><span class=n>normh1ExactSolution</span>
</span></span><span class=line><span class=cl><span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>relError</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linalg</span><span class=o>.</span><span class=n>norm</span><span class=p>(</span><span class=n>ReconstructedCompressedSolution</span><span class=o>-</span><span class=n>ExactSolution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;L2 relative compression error =&#34;</span><span class=p>,</span> <span class=n>relError</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;H1 relative compression error =&#34;</span><span class=p>,</span> <span class=n>relh1Error</span><span class=p>)</span>
</span></span></code></pre></div><pre><code>-----------------------------------
     ONLINE PART          !!!      
-----------------------------------
Online Errors
Parameter nu: 0.00909090909090909
Parameter nu: 0.00909090909090909
L2 relative compression error = 0.0036365919269498643
H1 relative compression error = 0.0051482180568242445
</code></pre></div><time class="mt-12 mb-8 block text-xs text-gray-500 ltr:text-right rtl:text-left dark:text-gray-400" datetime=2024-12-13T10:19:20.000Z><span>Last updated on</span>
Dec 13, 2024</time><div class="container mx-auto prose prose-slate lg:prose-xl dark:prose-invert mt-5"><div class="max-w-prose print:hidden"><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fnirb2grid%2F&amp;text=" title=X aria-label=X id=share-link-x><svg style="height:1em" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fnirb2grid%2F&amp;t=" title=Facebook aria-label=Facebook id=share-link-facebook><svg style="height:1em" viewBox="0 0 24 24"><path fill="currentcolor" d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55.0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?subject=&amp;body=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fnirb2grid%2F" title=Email aria-label=Email id=share-link-email><svg style="height:1em" viewBox="0 0 24 24"><path fill="none" stroke="currentcolor" stroke-linecap="round" stroke-width="1.5" d="M16.5 12a4.5 4.5.0 11-9 0 4.5 4.5.0 019 0zm0 0c0 1.657 1.007 3 2.25 3S21 13.657 21 12a9 9 0 10-2.636 6.364M16.5 12V8.25"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fnirb2grid%2F&amp;title=" title=LinkedIn aria-label=LinkedIn id=share-link-linkedin><svg style="height:1em" height="1em" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="whatsapp://send?text=%20https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fnirb2grid%2F" title=WhatsApp aria-label=WhatsApp id=share-link-whatsapp><svg style="height:1em" viewBox="0 0 256 256" fill="currentcolor"><path d="m187.58 144.84-32-16a8 8 0 00-8 .5l-14.69 9.8a40.55 40.55.0 01-16-16l9.8-14.69a8 8 0 00.5-8l-16-32A8 8 0 00104 64a40 40 0 00-40 40 88.1 88.1.0 0088 88 40 40 0 0040-40 8 8 0 00-4.42-7.16zM152 176a72.08 72.08.0 01-72-72 24 24 0 0119.29-23.54l11.48 23L101 118a8 8 0 00-.73 7.51 56.47 56.47.0 0030.15 30.15A8 8 0 00138 155l14.61-9.74 23 11.48A24 24 0 01152 176zM128 24A104 104 0 0036.18 176.88l-11.35 34.05a16 16 0 0020.24 20.24l34.05-11.35A104 104 0 10128 24zm0 192a87.87 87.87.0 01-44.06-11.81 8 8 0 00-6.54-.67L40 216l12.47-37.4a8 8 0 00-.66-6.54A88 88 0 11128 216z"/></svg></a></section><div class="flex pt-12 pb-4"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Authors</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300"></div><div class="text-2xl sm:text-lg pt-1"><div class="flex flex-wrap text-neutral-500 dark:text-neutral-300"><a class="pr-2 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:reducedbases@gmail.com aria-label=At-Symbol><svg style="height:1em" viewBox="0 0 24 24"><path fill="none" stroke="currentcolor" stroke-linecap="round" stroke-width="1.5" d="M16.5 12a4.5 4.5.0 11-9 0 4.5 4.5.0 019 0zm0 0c0 1.657 1.007 3 2.25 3S21 13.657 21 12a9 9 0 10-2.636 6.364M16.5 12V8.25"/></svg></a></div></div></div></div><div class="pt-1 no-prose w-full"><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex flex-col md:flex-row flex-nowrap justify-between gap-5 pt-2"><div><a class="group flex no-underline" href=/post/eim/><span class="mt-[-0.3rem] me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"></span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">Dec 13, 2024</span></span></a></div><div><a class="group flex text-right no-underline" href=/post/pbdwadv/><span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500"></span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">Dec 13, 2024
</span></span><span class="mt-[-0.3rem] ms-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class=ltr:inline>&rarr;</span></span></a></div></div></div></div></div></main></article></div></div><div class=page-footer><footer class="container mx-auto flex flex-col justify-items-center text-sm leading-6 mt-24 mb-4 text-slate-700 dark:text-slate-200"><p class="powered-by text-center">Thanks</p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class="powered-by text-center">Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target=_blank rel=noopener>Hugo Blox Builder</a> — the free, <a href=https://github.com/HugoBlox/hugo-blox-builder target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></body></html>