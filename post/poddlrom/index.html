<!doctype html><!-- This site was created with Hugo Blox. https://hugoblox.com --><!-- Last Published: April 15, 2025 --><html lang=en-us dir=ltr data-wc-theme-default=light><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=generator content="Hugo Blox Builder 0.2.0"><meta name=description content="THE POD-DL-ROM
Script by Elise Grosjean (ENSTA-Paris, elise.grosjean@ensta-paris.fr)
import sys
#!{sys.executable} -m pip install numpy
#!{sys.executable} -m pip install matplotlib
#!{sys.executable} -m pip install scikit-fem
#!{sys.executable} -m pip install tensorflow
Let us consider a parameterized problem. Having (previously computed) solutions for different parameter values, we aim at approaching much faster &ldquo;online&rdquo; the solution associated to a new parameter value.
To do so, we will employ a POD-DL-ROM strategy as in the paper &ldquo;POD-DL-ROM: Enhancing deep learning-based reduced order models for nonlinear parametrized PDEs by proper orthogonal decomposition&rdquo;.
The idea is to first compress the training solutions with a POD before relying on a DL-ROM approach (see also &ldquo;A comprehensive deep learning-based approach to reduced order modeling of nonlinear time-dependent parametrized PDEs&rdquo;)."><link rel=alternate hreflang=en-us href=https://reducedbasis.github.io/post/poddlrom/><link rel=stylesheet href=/css/themes/blue.min.css><link href=/dist/wc.min.css rel=stylesheet><script>window.hbb={defaultTheme:document.documentElement.dataset.wcThemeDefault,setDarkTheme:()=>{document.documentElement.classList.add("dark"),document.documentElement.style.colorScheme="dark"},setLightTheme:()=>{document.documentElement.classList.remove("dark"),document.documentElement.style.colorScheme="light"}},console.debug(`Default Hugo Blox Builder theme is ${window.hbb.defaultTheme}`),"wc-color-theme"in localStorage?localStorage.getItem("wc-color-theme")==="dark"?window.hbb.setDarkTheme():window.hbb.setLightTheme():(window.hbb.defaultTheme==="dark"?window.hbb.setDarkTheme():window.hbb.setLightTheme(),window.hbb.defaultTheme==="system"&&(window.matchMedia("(prefers-color-scheme: dark)").matches?window.hbb.setDarkTheme():window.hbb.setLightTheme()))</script><script>document.addEventListener("DOMContentLoaded",function(){let e=document.querySelectorAll("li input[type='checkbox'][disabled]");e.forEach(e=>{e.parentElement.parentElement.classList.add("task-list")});const t=document.querySelectorAll(".task-list li");t.forEach(e=>{let t=Array.from(e.childNodes).filter(e=>e.nodeType===3&&e.textContent.trim().length>1);if(t.length>0){const n=document.createElement("label");t[0].after(n),n.appendChild(e.querySelector("input[type='checkbox']")),n.appendChild(t[0])}})})</script><link rel=icon type=image/png href=/media/icon_hu16304263275779960481.png><link rel=apple-touch-icon type=image/png href=/media/icon_hu1534112029185156839.png><link rel=canonical href=https://reducedbasis.github.io/post/poddlrom/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@GetResearchDev"><meta property="twitter:creator" content="@GetResearchDev"><meta property="og:site_name" content="RBM Docs"><meta property="og:url" content="https://reducedbasis.github.io/post/poddlrom/"><meta property="og:title" content="The POD-DL-ROM | RBM Docs"><meta property="og:description" content="THE POD-DL-ROM
Script by Elise Grosjean (ENSTA-Paris, elise.grosjean@ensta-paris.fr)
import sys
#!{sys.executable} -m pip install numpy
#!{sys.executable} -m pip install matplotlib
#!{sys.executable} -m pip install scikit-fem
#!{sys.executable} -m pip install tensorflow
Let us consider a parameterized problem. Having (previously computed) solutions for different parameter values, we aim at approaching much faster &ldquo;online&rdquo; the solution associated to a new parameter value.
To do so, we will employ a POD-DL-ROM strategy as in the paper &ldquo;POD-DL-ROM: Enhancing deep learning-based reduced order models for nonlinear parametrized PDEs by proper orthogonal decomposition&rdquo;.
The idea is to first compress the training solutions with a POD before relying on a DL-ROM approach (see also &ldquo;A comprehensive deep learning-based approach to reduced order modeling of nonlinear time-dependent parametrized PDEs&rdquo;)."><meta property="og:image" content="https://reducedbasis.github.io/media/icon_hu8177510199143947247.png"><meta property="twitter:image" content="https://reducedbasis.github.io/media/icon_hu8177510199143947247.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-12-13T10:19:20+01:00"><meta property="article:modified_time" content="2024-12-13T10:19:20+01:00"><title>The POD-DL-ROM | RBM Docs</title><style>@font-face{font-family:inter var;font-style:normal;font-weight:100 900;font-display:swap;src:url(/dist/font/Inter.var.woff2)format(woff2)}</style><link type=text/css rel=stylesheet href=/dist/pagefind/pagefind-ui.be766eb419317a14ec769d216e9779bfe8f3737c80e780f4ba0dafb57a41a482.css integrity="sha256-vnZutBkxehTsdp0hbpd5v+jzc3yA54D0ug2vtXpBpII="><script src=/dist/pagefind/pagefind-ui.87693d7c6f2b3b347ce359d0ede762c033419f0a32b22ce508c335a81d841f1b.js integrity="sha256-h2k9fG8rOzR841nQ7ediwDNBnwoysizlCMM1qB2EHxs="></script><script>window.hbb.pagefind={baseUrl:"/"}</script><style>html.dark{--pagefind-ui-primary:#eeeeee;--pagefind-ui-text:#eeeeee;--pagefind-ui-background:#152028;--pagefind-ui-border:#152028;--pagefind-ui-tag:#152028}</style><script>window.addEventListener("DOMContentLoaded",e=>{new PagefindUI({element:"#search",showSubResults:!0,baseUrl:window.hbb.pagefind.baseUrl,bundlePath:window.hbb.pagefind.baseUrl+"pagefind/"})}),document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("search"),t=document.getElementById("search_toggle");t&&t.addEventListener("click",()=>{if(e.classList.toggle("hidden"),e.querySelector("input").value="",e.querySelector("input").focus(),!e.classList.contains("hidden")){let t=document.querySelector(".pagefind-ui__search-clear");t&&!t.hasAttribute("listenerOnClick")&&(t.setAttribute("listenerOnClick","true"),t.addEventListener("click",()=>{e.classList.toggle("hidden")}))}})})</script><link type=text/css rel=stylesheet href=/dist/lib/katex/katex.min.505d5f829022bb7b4f24dfee0aa1141cd7bba67afe411d1240335f820960b5c3.css integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM="><script defer src=/dist/lib/katex/katex.min.dc84b296ec3e884de093158f760fd9d45b6c7abe58b5381557f4e138f46a58ae.js integrity="sha256-3ISyluw+iE3gkxWPdg/Z1Ftser5YtTgVV/ThOPRqWK4="></script><script defer src=/js/katex-renderer.6579ec9683211cfb952064aedf3a3baea5eeb17a061775b32b70917474637c80.js integrity="sha256-ZXnsloMhHPuVIGSu3zo7rqXusXoGF3WzK3CRdHRjfIA="></script><script defer src=/js/hugo-blox-en.min.e5fa931947cac2d947732ea37a770aae2b5bd4a50b6048060cd129b46159a06d.js integrity="sha256-5fqTGUfKwtlHcy6jencKritb1KULYEgGDNEptGFZoG0="></script></head><body class="dark:bg-hb-dark dark:text-white page-wrapper" id=top><div id=page-bg></div><div class="page-header sticky top-0 z-30"><header id=site-header class=header><nav class="navbar px-3 flex justify-left"><div class="order-0 h-100"><a class=navbar-brand href=/ title="RBM Docs"><img fetchpriority=high decoding=async width=49 height=36 src=/media/logo_hu9071661120962382538.webp alt="RBM Docs"></a></div><input id=nav-toggle type=checkbox class=hidden>
<label for=nav-toggle class="order-3 cursor-pointer flex items-center lg:hidden text-dark dark:text-white lg:order-1"><svg id="show-button" class="h-6 fill-current block" viewBox="0 0 20 20"><title>Open Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0V0z"/></svg>
<svg id="hide-button" class="h-6 fill-current hidden" viewBox="0 0 20 20"><title>Close Menu</title><polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2" transform="rotate(45 10 10)"/></svg></label><ul id=nav-menu class="navbar-nav order-3 hidden lg:flex w-full pb-6 lg:order-1 lg:w-auto lg:space-x-2 lg:pb-0 xl:space-x-8 justify-left"><li class=nav-item><a class=nav-link href=/>Home</a></li><li class=nav-item><a class=nav-link href=/docs/>Documentation</a></li><li class=nav-item><a class=nav-link href=/blog/>News</a></li><li class=nav-item><a class=nav-link href=/showcase/>Other examples</a></li><li class=nav-item><a class=nav-link href=/events/>Events</a></li><li class="mt-4 inline-block lg:hidden"><a href=/>Get Started</a></li></ul><div class="order-1 ml-auto flex items-center md:order-2 lg:ml-0"><button aria-label=search class="text-black hover:text-primary inline-block px-3 text-xl dark:text-white" id=search_toggle>
<svg height="16" width="16" viewBox="0 0 512 512" fill="currentcolor"><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8.0 45.3s-32.8 12.5-45.3.0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9.0 208S93.1.0 208 0 416 93.1 416 208zM208 352a144 144 0 100-288 144 144 0 100 288z"/></svg></button><div class="px-3 text-black hover:text-primary-700 dark:text-white dark:hover:text-primary-300
[&.active]:font-bold [&.active]:text-black/90 dark:[&.active]:text-white"><button class="theme-toggle mt-1" accesskey=t title=appearance>
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dark:hidden"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="dark:block [&:not(dark)]:hidden"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div><a href=/ class="inline-block rounded border px-5 py-2 font-semibold transition
md:ml-4 px-4 py-1.5 text-sm
border-black hover:bg-black dark:hover:bg-white dark:hover:text-black hover:text-white dark:border-white dark:text-white dark:hover:bg-white
hidden lg:inline-block">Get Started</a></div></nav></header><div id=search class="hidden p-3"></div></div><div class="page-body my-10"><div class="mx-auto flex max-w-screen-xl"><aside class="hb-sidebar-container max-lg:[transform:translate3d(0,-100%,0)] lg:hidden xl:block"><div class="px-4 pt-4 lg:hidden"></div><div class="hb-scrollbar lg:h-[calc(100vh-var(--navbar-height))]"><ul class="flex flex-col gap-1 lg:hidden"><li class=open><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/>Posts
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/eim/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/nirb2grid/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/pbdwadv/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/pbdwhelmholtz/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/podgalerkin/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/podi/>index</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/pbdw/>My Post</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/offline/>Offline part</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/post/rsvd/>random Singular Value Decomposition</a></li><li class="flex flex-col open"><a class="hb-sidebar-custom-link
sidebar-active-item bg-primary-100 font-semibold text-primary-800 dark:bg-primary-300 dark:text-primary-900" href=/post/poddlrom/>The POD-DL-ROM</a><ul class=hb-sidebar-mobile-toc><li><a href=#1-an-unsteady-advectiondiffusionreaction-equation class=hb-docs-link>1) An unsteady advection–diffusion–reaction equation:</a></li><li><a href=#2-the-pod-dl-rom-method class=hb-docs-link>2) The POD-DL-ROM method</a></li></ul></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/blog/>Recent and Upcoming methods
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/blog/v1.0.0/>PBDW v1 released!</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/blog/todolist/>TODO list</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/showcase/>More applications
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/showcase/cavity/>Cavity</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/>Documentation
<span data-hb-sidebar-toggle><svg fill="none" viewBox="0 0 24 24" stroke="currentcolor" class="h-[18px] min-w-[18px] rounded-sm p-0.5 hover:bg-gray-800/5 dark:hover:bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="origin-center transition-transform rtl:-rotate-180"/></svg></span></a><div class="ltr:pr-0 overflow-hidden"><ul class=hb-sidebar-list><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/poddlrom/>POD-DL-ROM</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/pod/>POD-Galerkin</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/podi/>POD-Interpolation</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/eim/>EIM</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/nirb2grid/>NIRB 2-grid</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/pbdw/>PBDW</a></li><li class="flex flex-col"><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/docs/reference/>References</a></li></ul></div></li><li><a class="hb-sidebar-custom-link
text-gray-500 hover:bg-gray-100 hover:text-gray-900 dark:text-gray-300 dark:hover:bg-primary-800 dark:hover:text-gray-50" href=/events/>Events</a></li></ul><div class="max-xl:hidden h-0 w-64 shrink-0"></div></div></aside><nav class="hb-toc order-last hidden w-64 shrink-0 xl:block print:hidden px-4" aria-label="table of contents"><div class="hb-scrollbar text-sm [hyphens:auto] sticky top-16 overflow-y-auto pr-4 pt-6 max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] -mr-4 rtl:-ml-4"><p class="mb-4 font-semibold tracking-tight">On this page</p><ul><li class="my-2 scroll-my-6 scroll-py-6"><a class="font-semibold inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#1-an-unsteady-advectiondiffusionreaction-equation>1) An unsteady advection–diffusion–reaction equation:</a></li></ul><ul><li class="my-2 scroll-my-6 scroll-py-6"><a class="font-semibold inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#2-the-pod-dl-rom-method>2) The POD-DL-ROM method</a></li><li class="my-2 scroll-my-6 scroll-py-6"><a class="pl-8 rtl:pr-8 inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#offline-part>OFFLINE PART</a></li><li class="my-2 scroll-my-6 scroll-py-6"><a class="pl-4 rtl:pr-4 inline-block text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-300 w-full break-words" href=#now-we-can-proceed-with-the-online-step>Now we can proceed with the online step</a></li></ul><div class=backlinks><div class="mb-1 font-semibold tracking-tight">Backlinks</div><ul><li><a href=/docs/poddlrom/ class=backlink>POD-DL-ROM</a></li></ul></div></div></nav><article class="w-full break-words flex min-h-[calc(100vh-var(--navbar-height))] min-w-0 justify-center pb-8 pr-[calc(env(safe-area-inset-right)-1.5rem)]"><main class="w-full min-w-0 max-w-6xl px-6 pt-4 md:px-12"><h1 class="mt-2 text-4xl font-bold tracking-tight text-slate-900 dark:text-slate-100">The POD-DL-ROM</h1><div class="mt-4 mb-16"><div class="text-gray-500 dark:text-gray-300 text-sm flex items-center flex-wrap gap-y-2"><span class=mr-1>Dec 13, 2024</span>
<span class=mx-1>·</span>
<span class=mx-1>2 min read</span></div><div class=mt-3></div></div><div class="prose prose-slate lg:prose-xl dark:prose-invert"><h1 id=the-pod-dl-rom>THE POD-DL-ROM</h1><p>Script by Elise Grosjean (ENSTA-Paris, <a href=mailto:elise.grosjean@ensta-paris.fr>elise.grosjean@ensta-paris.fr</a>)</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=c1>#!{sys.executable} -m pip install numpy</span>
</span></span><span class=line><span class=cl><span class=c1>#!{sys.executable} -m pip install matplotlib</span>
</span></span><span class=line><span class=cl><span class=c1>#!{sys.executable} -m pip install scikit-fem</span>
</span></span><span class=line><span class=cl><span class=c1>#!{sys.executable} -m pip install tensorflow</span>
</span></span></code></pre></div><p>Let us consider a parameterized problem. Having (previously computed) solutions for different parameter values, we aim at approaching much faster &ldquo;online&rdquo; the solution associated to a new parameter value.
To do so, we will employ a POD-DL-ROM strategy as in the paper &ldquo;POD-DL-ROM: Enhancing deep learning-based reduced order models for nonlinear parametrized PDEs by proper orthogonal decomposition&rdquo;.
The idea is to first compress the training solutions with a POD before relying on a DL-ROM approach (see also &ldquo;A comprehensive deep learning-based approach to reduced order modeling of nonlinear time-dependent parametrized PDEs&rdquo;).</p><p>This prior dimensionality reduction through a randomized singular value decomposition (rSVD) avoids to feed training data of large dimension $\mathcal{N}_h$ (even if the number of modes $N$ required for the POD is big, we assume here that $N << \mathcal{N}_h$ where $\mathcal{N}_h$ denotes the number of degrees of freedom. Indeed, although extremely efficient at testing time, when evaluating the PDE solution for any new testing-parameter instance, DL-ROMs require an expensive training stage, because of the extremely large number of network parameters (weights/biases) to be estimated. When $N$ is large (i.e. when the dimension of the linear trial subspace becomes very large), this ROM technique shows efficient computational performances during both offline and online stages, compared to classical projection-based ROMs.</p><p>To sum up this ROM technique, a two-step dimensionality reduction is performed: first, POD (realized through rSVD) is applied on a set of High-Fidelity (HF) snapshots, then a DL-ROM is built to approximate the map between the parameters and the POD coordinates.</p><p>After the data compression with a rSVD, the training strategy consists in:</p><ul><li>1/ encoding the compressed solution with a CAE that goes from $\mathbb{R}^N \to \mathbb{R}^n$ with the dimension of the latent space $n$ as close as possible to the number of parameters ($n<<n $),</li><li>2/ learning to approximate the latent space with a DFNN,</li><li>3/ decoding this approximation to find the original solution.</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># import packages</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>skfem</span>  <span class=c1># for Finite Element Method</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>matplotlib.pyplot</span> <span class=k>as</span> <span class=nn>plt</span> 
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>sklearn.utils.extmath</span> <span class=kn>import</span> <span class=n>randomized_svd</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>tensorflow</span> <span class=k>as</span> <span class=nn>tf</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>itertools</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>random</span><span class=o>.</span><span class=n>seed</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span>
</span></span></code></pre></div><pre><code>2025-04-15 13:49:21.531644: I tensorflow/core/platform/cpu_feature_guard.cc:210] This TensorFlow binary is optimized to use available CPU instructions in performance-critical operations.
To enable the following instructions: AVX2 FMA, in other operations, rebuild TensorFlow with the appropriate compiler flags.
</code></pre><h2 id=1-an-unsteady-advectiondiffusionreaction-equation>1) An unsteady advection–diffusion–reaction equation:</h2><h1 id=heading></h1><p>We are going to use in this example an unsteady advection-diffusion-reaction problem with the Finite Element Method (FEM), which consists in
solving on a unit square (denoted $\Omega$) the following equations:</p>$$\begin{align*}
&\partial_t u - \nabla \cdot(\mu_1 \nabla u) + b(t;\mu)\cdot \nabla u + c u =f(\mu_3,\mu_4), \textrm{ in } \Omega \times (0,T),\\
& \mu_1 \nabla u \cdot n=0, \textrm{ on } \partial \Omega \times (0,T),\\
& u(0)=0, \textrm{ in } \Omega,\\
\end{align*}$$<p>Here, $\mu=(\mu_1,\mu_2,\mu_3,\mu_4)$ is our parameter of interest.
We employ P1 elements with a backward time scheme of order 2.</p><p>The parameter set is given by $[0.002, 0.005] × [30, 70] × [0.4, 0.6]^2$</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; First we define a mesh for the unit square with the boundary decomposition &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>mesh</span><span class=o>=</span> <span class=n>skfem</span><span class=o>.</span><span class=n>MeshTri</span><span class=p>()</span><span class=o>.</span><span class=n>refined</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span><span class=o>.</span><span class=n>with_boundaries</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>                                                                                                                                
</span></span><span class=line><span class=cl>            <span class=s2>&#34;left&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;right&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;down&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>0</span><span class=p>,</span>                                                                                            
</span></span><span class=line><span class=cl>            <span class=s2>&#34;up&#34;</span><span class=p>:</span> <span class=k>lambda</span> <span class=n>x</span><span class=p>:</span> <span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=mi>1</span><span class=p>,</span>     
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=p>}</span>                                                                                                                               
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>mesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>mesh</span>
</span></span></code></pre></div><pre><code>&lt;skfem MeshTri1 object&gt;
  Number of elements: 8192
  Number of vertices: 4225
  Number of nodes: 4225
  Named boundaries [# facets]: left [64], bottom [64], right [64], top [64], down [64], up [64]
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_5_1.svg alt=svg loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Then we assemble the matrices of our model problem &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Assembling matrices</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem.assembly</span> <span class=kn>import</span> <span class=n>BilinearForm</span><span class=p>,</span> <span class=n>LinearForm</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem.helpers</span> <span class=kn>import</span> <span class=n>grad</span><span class=p>,</span> <span class=n>dot</span><span class=p>,</span><span class=n>div</span><span class=p>,</span><span class=n>ddot</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>laplace</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>dot</span><span class=p>(</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>),</span> <span class=n>grad</span><span class=p>(</span><span class=n>v</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>b1</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>telt</span><span class=o>=</span><span class=n>w</span><span class=o>.</span><span class=n>telt</span>
</span></span><span class=line><span class=cl>    <span class=c1>#print(telt)</span>
</span></span><span class=line><span class=cl>    <span class=n>mu2</span><span class=o>=</span><span class=n>w</span><span class=o>.</span><span class=n>mu2</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span><span class=o>=</span><span class=p>[</span><span class=n>np</span><span class=o>.</span><span class=n>cos</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>pi</span><span class=o>/</span><span class=n>mu2</span><span class=o>*</span><span class=n>telt</span><span class=p>),</span><span class=n>np</span><span class=o>.</span><span class=n>sin</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>pi</span><span class=o>/</span><span class=n>mu2</span><span class=o>*</span><span class=n>telt</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>b</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>)[</span><span class=mi>0</span><span class=p>]</span><span class=o>*</span><span class=n>v</span><span class=o>+</span><span class=n>b</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>grad</span><span class=p>(</span><span class=n>u</span><span class=p>)[</span><span class=mi>1</span><span class=p>]</span><span class=o>*</span><span class=n>v</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nd>@BilinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>mass</span><span class=p>(</span><span class=n>u</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>_</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u</span> <span class=o>*</span> <span class=n>v</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nd>@LinearForm</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>linearterm</span><span class=p>(</span><span class=n>v</span><span class=p>,</span> <span class=n>w</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>mu3</span><span class=o>=</span><span class=n>w</span><span class=o>.</span><span class=n>mu3</span>
</span></span><span class=line><span class=cl>    <span class=n>mu4</span><span class=o>=</span><span class=n>w</span><span class=o>.</span><span class=n>mu4</span>
</span></span><span class=line><span class=cl>    <span class=n>f</span><span class=o>=</span><span class=mi>10</span><span class=o>*</span><span class=n>np</span><span class=o>.</span><span class=n>exp</span><span class=p>(</span><span class=o>-</span><span class=p>((</span><span class=n>w</span><span class=o>.</span><span class=n>x</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=o>-</span><span class=n>mu3</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=o>+</span><span class=p>(</span><span class=n>w</span><span class=o>.</span><span class=n>x</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=o>-</span><span class=n>mu4</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=o>/</span><span class=mf>0.07</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>f</span><span class=o>*</span><span class=n>v</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>c</span><span class=o>=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Solving the problem &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=kn>from</span> <span class=nn>skfem</span> <span class=kn>import</span> <span class=o>*</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>element</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;u&#39;</span><span class=p>:</span> <span class=n>ElementTriP1</span><span class=p>()}</span> <span class=c1>#[u]= Solution with P1 FEM elements</span>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>visualize_solution</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span><span class=n>solution</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1>## Function that allows us to visualize the solution</span>
</span></span><span class=line><span class=cl>    <span class=kn>from</span> <span class=nn>skfem.visuals.matplotlib</span> <span class=kn>import</span> <span class=n>plot</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>plot</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>solution</span><span class=p>,</span> <span class=n>shading</span><span class=o>=</span><span class=s1>&#39;gouraud&#39;</span><span class=p>,</span> <span class=n>colorbar</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>SolveProblem_BDF2</span><span class=p>(</span><span class=n>mu</span><span class=p>,</span> <span class=n>Mesh</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34; Backward Differentiation Formula (BDF) of order 2 &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=n>mu1</span><span class=p>,</span><span class=n>mu2</span><span class=p>,</span><span class=n>mu3</span><span class=p>,</span><span class=n>mu4</span> <span class=o>=</span> <span class=n>mu</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>T</span> <span class=o>=</span> <span class=mi>10</span><span class=o>*</span><span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=c1>#final time</span>
</span></span><span class=line><span class=cl>    <span class=n>dt</span> <span class=o>=</span>  <span class=mi>5</span><span class=o>*</span><span class=n>np</span><span class=o>.</span><span class=n>pi</span> <span class=o>/</span> <span class=mi>10</span> <span class=c1>#time step</span>
</span></span><span class=line><span class=cl>    <span class=n>basis</span> <span class=o>=</span> <span class=p>{</span><span class=n>variable</span><span class=p>:</span> <span class=n>Basis</span><span class=p>(</span><span class=n>Mesh</span><span class=p>,</span> <span class=n>e</span><span class=p>)</span> <span class=k>for</span> <span class=n>variable</span><span class=p>,</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>element</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span>  <span class=c1># FEM space</span>
</span></span><span class=line><span class=cl>    <span class=n>u_prev</span> <span class=o>=</span> <span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>]</span><span class=o>.</span><span class=n>zeros</span><span class=p>()</span>  <span class=c1># u_n (initial condition)</span>
</span></span><span class=line><span class=cl>    <span class=n>t_list</span><span class=o>=</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=c1>#time steps</span>
</span></span><span class=line><span class=cl>    <span class=n>u_list</span><span class=o>=</span><span class=p>[</span><span class=n>u_prev</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    <span class=n>u_curr</span> <span class=o>=</span> <span class=n>u_prev</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span>  <span class=c1># u_{n+1}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>M</span> <span class=o>=</span> <span class=n>mass</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>laplaceMat</span> <span class=o>=</span> <span class=n>mu1</span> <span class=o>*</span> <span class=n>laplace</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>lineartermV</span> <span class=o>=</span> <span class=n>linearterm</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span> <span class=n>mu3</span><span class=o>=</span><span class=n>mu3</span><span class=p>,</span> <span class=n>mu4</span><span class=o>=</span><span class=n>mu4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># implicit scheme - order 1 for init</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span> <span class=o>=</span> <span class=n>dt</span>
</span></span><span class=line><span class=cl>    <span class=n>B1</span> <span class=o>=</span> <span class=n>b1</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span> <span class=n>mu2</span><span class=o>=</span><span class=n>mu2</span><span class=p>,</span> <span class=n>telt</span><span class=o>=</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>K1</span> <span class=o>=</span> <span class=n>M</span> <span class=o>/</span> <span class=n>dt</span> <span class=o>+</span> <span class=n>laplaceMat</span> <span class=o>+</span> <span class=n>B1</span> <span class=o>+</span> <span class=n>c</span><span class=o>*</span><span class=n>M</span> <span class=c1>#c=1</span>
</span></span><span class=line><span class=cl>    <span class=n>lineartermT</span> <span class=o>=</span> <span class=n>lineartermV</span> <span class=o>+</span> <span class=n>M</span> <span class=o>@</span> <span class=n>u_prev</span> <span class=o>/</span> <span class=n>dt</span>
</span></span><span class=line><span class=cl>    <span class=n>u_curr</span> <span class=o>=</span> <span class=n>solve</span><span class=p>(</span><span class=n>K1</span><span class=p>,</span> <span class=n>lineartermT</span><span class=p>)</span>  <span class=c1># u_{n+1}</span>
</span></span><span class=line><span class=cl>    <span class=n>t_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dt</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>u_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>u_curr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># BDF2 iteration</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>t</span> <span class=ow>in</span> <span class=n>np</span><span class=o>.</span><span class=n>arange</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>dt</span><span class=p>,</span> <span class=n>T</span> <span class=p>,</span> <span class=n>dt</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>B2</span> <span class=o>=</span> <span class=n>b1</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>basis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span> <span class=n>mu2</span><span class=o>=</span><span class=n>mu2</span><span class=p>,</span> <span class=n>telt</span><span class=o>=</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>K2</span> <span class=o>=</span> <span class=p>(</span><span class=mi>3</span> <span class=o>/</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>dt</span><span class=p>))</span> <span class=o>*</span> <span class=n>M</span> <span class=o>+</span> <span class=n>laplaceMat</span> <span class=o>+</span> <span class=n>B2</span> <span class=o>+</span> <span class=n>c</span> <span class=o>*</span> <span class=n>M</span>
</span></span><span class=line><span class=cl>        <span class=n>lineartermT</span> <span class=o>=</span> <span class=n>lineartermV</span> <span class=o>+</span> <span class=p>(</span><span class=mi>2</span> <span class=o>/</span> <span class=n>dt</span><span class=p>)</span> <span class=o>*</span> <span class=n>M</span> <span class=o>@</span> <span class=n>u_curr</span> <span class=o>-</span> <span class=p>(</span><span class=mi>1</span> <span class=o>/</span> <span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=n>dt</span><span class=p>))</span> <span class=o>*</span> <span class=n>M</span> <span class=o>@</span> <span class=n>u_prev</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>u_next</span> <span class=o>=</span> <span class=n>solve</span><span class=p>(</span><span class=n>K2</span><span class=p>,</span> <span class=n>lineartermT</span><span class=p>)</span>  <span class=c1># u_{n+2}</span>
</span></span><span class=line><span class=cl>        <span class=n>u_prev</span><span class=p>,</span> <span class=n>u_curr</span> <span class=o>=</span> <span class=n>u_curr</span><span class=p>,</span> <span class=n>u_next</span>  <span class=c1># Update</span>
</span></span><span class=line><span class=cl>        <span class=n>t_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>t</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>u_list</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>u_curr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>u_list</span><span class=p>,</span><span class=n>t_list</span>  <span class=c1>#[u_curr], [t] #</span>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=p>,</span><span class=n>t_list</span><span class=o>=</span><span class=n>SolveProblem_BDF2</span><span class=p>([[</span><span class=mf>0.0045</span><span class=p>,</span><span class=mi>50</span><span class=p>,</span><span class=mf>0.2</span><span class=p>,</span> <span class=mf>0.475</span><span class=p>]],</span><span class=n>mesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>mesh</span><span class=p>,</span><span class=n>velocity</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>velocity</span><span class=p>,</span><span class=n>t_list</span><span class=o>=</span><span class=n>SolveProblem_BDF2</span><span class=p>([[</span><span class=mf>0.006</span><span class=p>,</span><span class=mi>35</span><span class=p>,</span><span class=mf>0.475</span><span class=p>,</span> <span class=mf>0.475</span><span class=p>]],</span><span class=n>mesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>mesh</span><span class=p>,</span><span class=n>velocity</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Number of time stepps&#34;</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=n>velocity</span><span class=p>))</span>
</span></span></code></pre></div><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_7_0.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_7_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><pre><code>Number of time stepps 20
</code></pre><h2 id=2-the-pod-dl-rom-method>2) The POD-DL-ROM method</h2><p>We are now able to proceed with the offline and online parts of the POD-DL-ROM method.</p><h4 id=offline-part>OFFLINE PART</h4><p>We define one mesh and the associated finite element spaces (as before).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## FINE MESH</span>
</span></span><span class=line><span class=cl><span class=n>FineMesh</span> <span class=o>=</span> <span class=n>skfem</span><span class=o>.</span><span class=n>MeshTri</span><span class=p>()</span><span class=o>.</span><span class=n>refined</span><span class=p>(</span><span class=mi>6</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineBasis</span> <span class=o>=</span> <span class=p>{</span><span class=n>variable</span><span class=p>:</span> <span class=n>Basis</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span> <span class=n>e</span><span class=p>,</span> <span class=n>intorder</span><span class=o>=</span><span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>for</span> <span class=n>variable</span><span class=p>,</span> <span class=n>e</span> <span class=ow>in</span> <span class=n>element</span><span class=o>.</span><span class=n>items</span><span class=p>()}</span> <span class=c1># FEM space</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NumberOfNodesFineMesh</span> <span class=o>=</span> <span class=n>FineMesh</span><span class=o>.</span><span class=n>p</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Number of nodes: &#34;</span><span class=p>,</span><span class=n>NumberOfNodesFineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#num_dofs_uFineMesh = basis[&#39;u&#39;].doflocs.shape[1] # or np.shape(velocity)[0] for DOFs</span>
</span></span></code></pre></div><pre><code>Number of nodes:  4225
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># &#34;&#34;&#34; TRAINING set &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;        Offline                    &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># The parameter set is given by $[0.002, 0.005] × [30, 70] × [0.4, 0.6]^2$</span>
</span></span><span class=line><span class=cl><span class=c1># and we take for the training set 4*5*5*5 uniformly distributed in each parametric direction</span>
</span></span><span class=line><span class=cl><span class=c1>#Nt = 100 time instances</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mu1_values</span> <span class=o>=</span> <span class=mf>0.004</span> <span class=c1># np.linspace(0.002, 0.005, 4)  # 4 valeurs dans [0.002, 0.005]</span>
</span></span><span class=line><span class=cl><span class=n>mu2_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=mi>100</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>        <span class=c1># 5 valeurs dans [30, 70]</span>
</span></span><span class=line><span class=cl><span class=n>mu3_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mf>0.4</span><span class=p>,</span> <span class=mf>0.6</span><span class=p>,</span> <span class=mi>6</span><span class=p>)</span>      <span class=c1># 5 valeurs dans [0.4, 0.6]</span>
</span></span><span class=line><span class=cl><span class=n>mu4_values</span> <span class=o>=</span> <span class=mf>0.5</span> <span class=c1>#np.linspace(0.4, 0.6, 5)</span>
</span></span><span class=line><span class=cl><span class=n>mu5_values</span> <span class=o>=</span> <span class=n>t_list</span> <span class=c1># additional parameter = time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu1: &#34;</span><span class=p>,</span><span class=n>mu1_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu2: &#34;</span><span class=p>,</span><span class=n>mu2_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu3: &#34;</span><span class=p>,</span><span class=n>mu3_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu4: &#34;</span><span class=p>,</span><span class=n>mu4_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#param_combinations = list(itertools.product(mu1_values, mu2_values, mu3_values, mu4_values)) </span>
</span></span><span class=line><span class=cl><span class=n>param_combinations</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span> <span class=n>mu2_values</span><span class=p>,</span> <span class=n>mu3_values</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineSnapshots</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>muParam</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>mu</span> <span class=ow>in</span> <span class=n>param_combinations</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>    <span class=c1>#print(mu[0])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>mutmp</span><span class=o>=</span><span class=p>[</span><span class=n>mu1_values</span><span class=p>,</span><span class=n>mu</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>mu</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>mu4_values</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>solution</span><span class=p>,</span><span class=n>_</span><span class=o>=</span><span class=n>SolveProblem_BDF2</span><span class=p>([</span><span class=n>mutmp</span><span class=p>],</span><span class=n>FineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mu_full</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>hstack</span><span class=p>([[</span><span class=n>mu</span><span class=p>]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>velocity</span><span class=p>)</span> <span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>mu5_values</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=nb>len</span><span class=p>(</span><span class=n>velocity</span><span class=p>),</span><span class=mi>1</span><span class=p>))])</span>  <span class=c1># we add time as a parameter mu5</span>
</span></span><span class=line><span class=cl>    <span class=n>mu_full</span> <span class=o>=</span> <span class=n>mu_full</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>muParam</span> <span class=o>+=</span> <span class=n>mu_full</span> 
</span></span><span class=line><span class=cl>    <span class=n>FineSnapshots</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Number of training parameters: &#34;</span><span class=p>,</span><span class=nb>len</span><span class=p>(</span><span class=n>muParam</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;First parameter:&#34;</span><span class=p>,</span> <span class=n>muParam</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Shape snapshots matrix: &#34;</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>)))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>solution</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>-----------------------------------
        Offline                    
-----------------------------------
mu1:  0.004
mu2:  [ 10.  16.  22.  28.  34.  40.  46.  52.  58.  64.  70.  76.  82.  88.
  94. 100.]
mu3:  [0.4  0.44 0.48 0.52 0.56 0.6 ]
mu4:  0.5
Number of training parameters:  1920
First parameter: [10.0, 0.4, 0.0]
Shape snapshots matrix:  (96, 20, 4225)
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_12_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><p>Now we proceed with the data compression (Random Singular Decomposition Value: see <a href=https://reducedbasis.github.io/post/rsvd/ target=_blank rel=noopener>https://reducedbasis.github.io/post/rsvd/</a> for more details).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## randomSVD on the snapshots</span>
</span></span><span class=line><span class=cl><span class=n>NumberOfModes</span><span class=o>=</span><span class=mi>64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>start_time</span><span class=o>=</span><span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>FineSnapshotsMat</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape snapshots: &#34;</span><span class=p>,</span> <span class=n>FineSnapshotsMat</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=c1>#NS, NumberOfDegreesOfFreedrom (NS=Ntrain*NT)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>U</span><span class=p>,</span> <span class=n>Sigma</span><span class=p>,</span> <span class=n>VT</span> <span class=o>=</span> <span class=n>randomized_svd</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>FineSnapshotsMat</span><span class=p>)</span><span class=o>.</span><span class=n>transpose</span><span class=p>(),</span> 
</span></span><span class=line><span class=cl>                              <span class=n>n_components</span><span class=o>=</span><span class=n>NumberOfModes</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                              <span class=n>n_iter</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> 
</span></span><span class=line><span class=cl>                              <span class=n>random_state</span><span class=o>=</span><span class=mi>42</span><span class=p>)</span>  <span class=c1>#m=10 (oversampling default value)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ReducedBasis</span> <span class=o>=</span> <span class=n>U</span><span class=p>[:,</span> <span class=p>:</span><span class=n>NumberOfModes</span><span class=p>]</span>  <span class=c1># (Ndof x NumberOfModes)</span>
</span></span><span class=line><span class=cl><span class=n>EigenValues</span> <span class=o>=</span> <span class=n>Sigma</span><span class=p>[:</span><span class=n>NumberOfModes</span><span class=p>]</span> <span class=o>**</span> <span class=mi>2</span>  
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape reduced basis: &#34;</span> <span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>ReducedBasis</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>end_time</span> <span class=o>=</span> <span class=n>time</span><span class=o>.</span><span class=n>time</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>execution_time</span> <span class=o>=</span> <span class=n>end_time</span> <span class=o>-</span> <span class=n>start_time</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Temps d&#39;exécution : </span><span class=si>{</span><span class=n>execution_time</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2> secondes&#34;</span><span class=p>)</span>
</span></span></code></pre></div><pre><code>shape snapshots:  (1920, 4225)
shape reduced basis:  (4225, 64)
Temps d'exécution : 0.334519 secondes
</code></pre><p>Now that we have computed the snapshots, we can decompose them in one training part and one testing part</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># In view of the DL-ROM strategy, we decompose Mtrain in [Mtrain, Mval] where Mval is of size alpha*NS </span>
</span></span><span class=line><span class=cl><span class=c1>#(and NS=Ntrain*NT, NT beeing the number of time steps) </span>
</span></span><span class=line><span class=cl><span class=c1># but first a random shuffle</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineSnapshotsMat</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>FineSnapshots</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape snapshots: &#34;</span><span class=p>,</span> <span class=n>FineSnapshotsMat</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=c1>#NS, NumberOfDegreesOfFreedrom (NS=Ntrain*NT)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#randomly shuffle to decompose in training/testing parts</span>
</span></span><span class=line><span class=cl><span class=n>indices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>FineSnapshotsMat</span><span class=p>)))</span> 
</span></span><span class=line><span class=cl><span class=n>random</span><span class=o>.</span><span class=n>shuffle</span><span class=p>(</span><span class=n>indices</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineSnapshots_training</span> <span class=o>=</span> <span class=p>[</span><span class=n>FineSnapshotsMat</span><span class=p>[</span><span class=n>i</span><span class=p>,:]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>indices</span><span class=p>]</span> <span class=c1>#R^NS=R^Ntrain*NT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>SVector</span><span class=o>=</span><span class=n>FineSnapshots_training</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span> <span class=c1># full snapshots</span>
</span></span><span class=line><span class=cl><span class=n>MVector</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>muParam</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>indices</span><span class=p>])</span> <span class=c1>#full parameters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>alpha</span> <span class=o>=</span> <span class=mf>0.1</span>  <span class=c1># e.g. 10% for testing</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=n>MVector</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>split_point</span> <span class=o>=</span> <span class=nb>int</span><span class=p>((</span><span class=mi>1</span> <span class=o>-</span> <span class=n>alpha</span><span class=p>)</span> <span class=o>*</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#parameters</span>
</span></span><span class=line><span class=cl><span class=n>M1</span> <span class=o>=</span> <span class=n>MVector</span><span class=p>[:</span><span class=n>split_point</span><span class=p>]</span>   <span class=c1># 90%</span>
</span></span><span class=line><span class=cl><span class=n>M2</span> <span class=o>=</span> <span class=n>MVector</span><span class=p>[</span><span class=n>split_point</span><span class=p>:]</span>   <span class=c1># 10%</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#values</span>
</span></span><span class=line><span class=cl><span class=n>S1</span> <span class=o>=</span> <span class=n>SVector</span><span class=p>[:</span><span class=n>split_point</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>S2</span> <span class=o>=</span> <span class=n>SVector</span><span class=p>[</span><span class=n>split_point</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;S1 (snapshots for training) shape:&#34;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;M2 (parameters for testing) shape:&#34;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M2</span><span class=p>))</span>
</span></span></code></pre></div><pre><code>shape snapshots:  (1920, 4225)
S1 (snapshots for training) shape: (1728, 4225)
M2 (parameters for testing) shape: (192, 3)
</code></pre><p>We compress the training and testing snapshots</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;------------------------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;  Compress training/testing snapshots           &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;------------------------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VTS1</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S1</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span><span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=n>VTS2</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S2</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span><span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S1</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>snap</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>S1</span><span class=p>):</span><span class=c1>#FineSnapshotsMat:</span>
</span></span><span class=line><span class=cl>    <span class=n>ExactSolution</span> <span class=o>=</span><span class=n>snap</span> <span class=c1>#size Nh</span>
</span></span><span class=line><span class=cl>    <span class=n>CompressedSolutionU</span><span class=o>=</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span><span class=nd>@ExactSolution</span> <span class=c1>#snapshot compression</span>
</span></span><span class=line><span class=cl>    <span class=n>VTS1</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span><span class=nd>@ExactSolution</span> <span class=c1>#snapshot compression</span>
</span></span><span class=line><span class=cl>    <span class=c1>#ReconstructedCompressedSolution = np.dot(VTS1[i], ReducedBasis.transpose())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>snap</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>S2</span><span class=p>):</span><span class=c1>#FineSnapshotsMat:</span>
</span></span><span class=line><span class=cl>    <span class=n>ExactSolution</span> <span class=o>=</span><span class=n>snap</span> <span class=c1>#size Nh</span>
</span></span><span class=line><span class=cl>    <span class=n>VTS2</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span><span class=nd>@ExactSolution</span> <span class=c1>#snapshot compression</span>
</span></span><span class=line><span class=cl>    <span class=c1>#ReconstructedCompressedSolution = np.dot(VTS2[i], ReducedBasis.transpose())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Compressed size&#34;</span><span class=p>,</span><span class=n>VTS1</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>VTS2</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>],</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ReconstructedCompressedSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>------------------------------------------------
  Compress training/testing snapshots           
------------------------------------------------
(1728, 4225)
Compressed size (1728, 64)
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_18_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## Normalization</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>## parameters training M1 and test M2 matrices ##
</span></span></span><span class=line><span class=cl><span class=s2>##
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>M1</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Mmax</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>M1</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=n>Mmin</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>M1</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>M1</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>Mmax</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>M1</span><span class=p>[:,</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>M1</span><span class=p>[:,</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Training parameters</span>
</span></span><span class=line><span class=cl><span class=n>M1train</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M1</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>M1</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>M1train</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=n>M1</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>])</span><span class=o>/</span><span class=p>(</span><span class=n>Mmax</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=c1>#M1train[:,4]=mu5_values[0] ##if only one time step</span>
</span></span><span class=line><span class=cl><span class=n>M1train</span><span class=o>=</span><span class=n>M1train</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Testing part</span>
</span></span><span class=line><span class=cl><span class=n>M2test</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>M2</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>M2test</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=n>M2</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>])</span><span class=o>/</span><span class=p>(</span><span class=n>Mmax</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#M2test[:,4]=mu5_values[0]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>## snapshots training S1 and test S2 matrices ##
</span></span></span><span class=line><span class=cl><span class=s2>##
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>Smax</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>max</span><span class=p>(</span><span class=n>VTS1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>Smin</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>min</span><span class=p>(</span><span class=n>VTS1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>S1train</span><span class=o>=</span><span class=p>(</span><span class=n>VTS1</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>S1train</span><span class=o>=</span><span class=n>S1train</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>S2test</span><span class=o>=</span><span class=p>(</span><span class=n>VTS2</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>NS1</span><span class=o>=</span><span class=n>S1train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;number of training parameters: &#34;</span><span class=p>,</span><span class=n>NS1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1>#print(np.shape(S2))</span>
</span></span></code></pre></div><pre><code>(1728, 3)
number of training parameters:  1728
0
</code></pre><p>The key ingredient here is the DFNN that allows to avoid the use of the encoder during the testing time, part that is costly.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=kn>from</span> <span class=nn>tensorflow.keras</span> <span class=kn>import</span> <span class=n>layers</span><span class=p>,</span> <span class=n>models</span><span class=p>,</span> <span class=n>initializers</span>
</span></span><span class=line><span class=cl><span class=c1># 1/ encode the solution with a CAE that goes from R^N -&gt; R^n with n as close as possible to the number of parameters (n&lt;=N)</span>
</span></span><span class=line><span class=cl><span class=c1># 2/ learn to approximate the latent space of the parameters with a DFNN </span>
</span></span><span class=line><span class=cl><span class=c1># 3/ decode this approximation to approach the original solution</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape S1 training:&#34;</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S1train</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape S2 validation:&#34;</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S2test</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape M1 parameters:&#34;</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M1train</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape M2 parameters:&#34;</span><span class=p>,</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M2test</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#Training inputs:</span>
</span></span><span class=line><span class=cl><span class=c1># Optimizers (learning rate = eta)</span>
</span></span><span class=line><span class=cl><span class=n>eta</span><span class=o>=</span><span class=mf>5e-4</span>
</span></span><span class=line><span class=cl><span class=c1>#NS1=S1train.shape[1]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Total number of training parameters:&#34;</span><span class=p>,</span> <span class=n>NS1</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>N_epochs</span><span class=o>=</span><span class=mi>2500</span> <span class=c1># Number of iterations</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Maximum iterations:&#34;</span><span class=p>,</span> <span class=n>N_epochs</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>BatchSize</span><span class=o>=</span><span class=mi>108</span> <span class=c1>#batch size (allows to save CPU memory) </span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Number of minibatches:&#34;</span><span class=p>,</span><span class=n>NS1</span><span class=o>/</span><span class=n>BatchSize</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=k>assert</span> <span class=n>NS1</span><span class=o>%</span><span class=n>BatchSize</span><span class=o>==</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=n>NbMiniBatches</span><span class=o>=</span><span class=nb>int</span><span class=p>(</span><span class=n>NS1</span><span class=o>/</span><span class=n>BatchSize</span><span class=p>)</span> <span class=c1># Number of Minibatches</span>
</span></span><span class=line><span class=cl><span class=c1># We can add an initialization of theta_0 from a coarser model</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>n</span><span class=o>=</span><span class=n>M1train</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;latent space dim:&#34;</span><span class=p>,</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;================&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Initialization &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;================&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_encoder</span><span class=p>(</span><span class=n>latent_dim</span><span class=o>=</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=c1># Input: need a latent space of dimension n &lt; NumberOfModes </span>
</span></span><span class=line><span class=cl>    <span class=c1># Output: Encoder (CAE)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Three conv filters:</span>
</span></span><span class=line><span class=cl>    <span class=c1># 1. 32 output pictures where each filter is a 5*5 matrix that scans the picture</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    It yields 5*5*1=25 weights for one filter and one bias</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    elu activation function as in the paper &#34;A comprehensive DL-based approach to ROM of nonlinear time-dependent parametrized PDEs&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1># 2. 64 output pictures stride=2 -&gt; jump one pixel at a time</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Input</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>(</span><span class=mi>8</span><span class=p>,</span> <span class=mi>8</span><span class=p>,</span> <span class=mi>1</span><span class=p>))</span> <span class=c1># picture of size 8*8 = sqrt(NumberOfModes)*sqrt(NumberOfModes)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Conv2D</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>strides</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=s1>&#39;same&#39;</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>inputs</span><span class=p>)</span>  <span class=c1># 8x8x32</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Conv2D</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>strides</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=s1>&#39;same&#39;</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>       <span class=c1># 4x4x64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Conv2D</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>strides</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=s1>&#39;same&#39;</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>      <span class=c1># 2x2x128</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Flatten</span><span class=p>()(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>latent</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>latent_dim</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;latent_vector&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>(</span><span class=n>inputs</span><span class=p>,</span> <span class=n>latent</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;encoder&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_dfnn</span><span class=p>(</span><span class=n>latent_dim</span><span class=o>=</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Input</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>(</span><span class=n>n</span><span class=p>,))</span> 
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>inputs</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=n>latent_dim</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=n>x</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>(</span><span class=n>inputs</span><span class=p>,</span> <span class=n>x</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>build_decoder</span><span class=p>(</span><span class=n>latent_dim</span><span class=o>=</span><span class=n>n</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=n>inputs</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Input</span><span class=p>(</span><span class=n>shape</span><span class=o>=</span><span class=p>(</span><span class=n>latent_dim</span><span class=p>,))</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>128</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Dense</span><span class=p>(</span><span class=mi>2</span> <span class=o>*</span> <span class=mi>2</span> <span class=o>*</span> <span class=mi>128</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>inputs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Reshape</span><span class=p>((</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>,</span> <span class=mi>128</span><span class=p>))(</span><span class=n>x</span><span class=p>)</span>  <span class=c1># last encoded part </span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Conv2DTranspose</span><span class=p>(</span><span class=mi>64</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>strides</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=s1>&#39;same&#39;</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>   <span class=c1># 4x4x64</span>
</span></span><span class=line><span class=cl>    <span class=n>x</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Conv2DTranspose</span><span class=p>(</span><span class=mi>32</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>strides</span><span class=o>=</span><span class=mi>2</span><span class=p>,</span><span class=n>padding</span><span class=o>=</span><span class=s1>&#39;same&#39;</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;elu&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span>   <span class=c1># 8x8x32</span>
</span></span><span class=line><span class=cl>    <span class=n>outputs</span> <span class=o>=</span> <span class=n>layers</span><span class=o>.</span><span class=n>Conv2DTranspose</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=n>kernel_size</span><span class=o>=</span><span class=mi>5</span><span class=p>,</span> <span class=n>padding</span><span class=o>=</span><span class=s1>&#39;same&#39;</span><span class=p>,</span> <span class=n>activation</span><span class=o>=</span><span class=s1>&#39;linear&#39;</span><span class=p>)(</span><span class=n>x</span><span class=p>)</span><span class=c1># Last layer to obtain a picture 8x8x1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>Model</span><span class=p>(</span><span class=n>inputs</span><span class=p>,</span> <span class=n>outputs</span><span class=p>,</span> <span class=n>name</span><span class=o>=</span><span class=s1>&#39;decoder&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>encoder</span> <span class=o>=</span> <span class=n>build_encoder</span><span class=p>(</span><span class=n>latent_dim</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>loss_enc</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>losses</span><span class=o>.</span><span class=n>MeanSquaredError</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>theta_E_stock</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>dfnn</span> <span class=o>=</span> <span class=n>build_dfnn</span><span class=p>(</span><span class=n>latent_dim</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>loss_dfnn</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>losses</span><span class=o>.</span><span class=n>MeanSquaredError</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>theta_DFNN_stock</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>decoder</span> <span class=o>=</span> <span class=n>build_decoder</span><span class=p>(</span><span class=n>latent_dim</span><span class=o>=</span><span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>loss_dec</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>losses</span><span class=o>.</span><span class=n>MeanSquaredError</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=c1>#loss_dec2 = lambda y_true, y_pred: 1 - tf.keras.losses.CosineSimilarity()(y_true, y_pred) #can try other errors</span>
</span></span><span class=line><span class=cl><span class=n>theta_D_stock</span> <span class=o>=</span> <span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>optimizer</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>keras</span><span class=o>.</span><span class=n>optimizers</span><span class=o>.</span><span class=n>Adam</span><span class=p>(</span><span class=n>learning_rate</span><span class=o>=</span><span class=n>eta</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;========================&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; Parameter optimization &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;========================&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Step 2: reshape in picture frame for CAE</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>S2test</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>S2_reshaped</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S2test</span><span class=p>,((</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span><span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>)),</span><span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>)),</span><span class=mi>1</span><span class=p>)))</span> <span class=c1># for encoder</span>
</span></span><span class=line><span class=cl><span class=n>S2_batch</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S2test</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>  <span class=c1>#for loss</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ne</span><span class=o>=</span><span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=k>while</span> <span class=n>ne</span><span class=o>&lt;=</span><span class=n>N_epochs</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=c1>#if ne==500 and total_loss&gt;=total_loss_prec: #early-stopping criterion</span>
</span></span><span class=line><span class=cl>    <span class=c1>#    print(f&#34;early stopping...ne=={ne}==500 and {total_loss}&gt;={total_loss_prec}&#34; )</span>
</span></span><span class=line><span class=cl>    <span class=c1>#   break</span>
</span></span><span class=line><span class=cl>    <span class=c1>#total_loss_prec=total_loss</span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;===========&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>## Training part </span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;===========&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=n>k</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>NbMiniBatches</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=c1># Iteration (ne, k)</span>
</span></span><span class=line><span class=cl>        <span class=n>iteration</span> <span class=o>=</span> <span class=n>NbMiniBatches</span> <span class=o>*</span> <span class=n>ne</span> <span class=o>+</span> <span class=n>k</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=c1># Step 1: sample minibatch [M_batch,S_batch] from M1, S1</span>
</span></span><span class=line><span class=cl>        <span class=n>start</span> <span class=o>=</span> <span class=n>k</span> <span class=o>*</span> <span class=n>BatchSize</span>
</span></span><span class=line><span class=cl>        <span class=n>end</span> <span class=o>=</span> <span class=n>start</span> <span class=o>+</span> <span class=n>BatchSize</span>
</span></span><span class=line><span class=cl>        <span class=n>M1_batch</span> <span class=o>=</span> <span class=n>M1train</span><span class=o>.</span><span class=n>T</span><span class=p>[</span><span class=n>start</span><span class=p>:</span><span class=n>end</span><span class=p>,:]</span>  <span class=c1># shape (n, 120)</span>
</span></span><span class=line><span class=cl>        <span class=n>S1_batch</span> <span class=o>=</span> <span class=n>S1train</span><span class=o>.</span><span class=n>T</span><span class=p>[</span><span class=n>start</span><span class=p>:</span><span class=n>end</span><span class=p>,:]</span>  <span class=c1># shape (N, 120)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 2: reshape in picture frame for CAE</span>
</span></span><span class=line><span class=cl>        <span class=n>S1_batch_reshaped</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>tf</span><span class=o>.</span><span class=n>cast</span><span class=p>(</span><span class=n>S1_batch</span><span class=p>,</span> <span class=n>tf</span><span class=o>.</span><span class=n>float32</span><span class=p>),(</span><span class=n>BatchSize</span><span class=p>,</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>)),</span> <span class=nb>int</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>NumberOfModes</span><span class=p>)),</span> <span class=mi>1</span><span class=p>))</span>          
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=c1># Step 3: encoder from S1_batch [Convolutional autoencoder (CAE)] + DFNN + decoder</span>
</span></span><span class=line><span class=cl>        <span class=c1># with tensorflow and an activation function ELU</span>
</span></span><span class=line><span class=cl>         
</span></span><span class=line><span class=cl>        <span class=k>with</span> <span class=n>tf</span><span class=o>.</span><span class=n>GradientTape</span><span class=p>()</span> <span class=k>as</span> <span class=n>tape</span><span class=p>:</span> <span class=c1># for automatic differentiation</span>
</span></span><span class=line><span class=cl>            <span class=c1># step a/</span>
</span></span><span class=line><span class=cl>            <span class=n>S1tilde_n_batch</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>(</span><span class=n>S1_batch_reshaped</span><span class=p>,</span><span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>   <span class=c1>#latent space that we want to approximate of shape (BatchSize, latent_dim)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># step b/</span>
</span></span><span class=line><span class=cl>            <span class=n>latent_pred</span> <span class=o>=</span> <span class=n>dfnn</span><span class=p>(</span><span class=n>M1_batch</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># function to approximate the latent space. shape: (BatchSize, latent_dim)       </span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c1># step c/</span>
</span></span><span class=line><span class=cl>            <span class=n>S_reconstructed</span> <span class=o>=</span> <span class=n>decoder</span><span class=p>(</span><span class=n>latent_pred</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>            <span class=n>St1_batch</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S_reconstructed</span><span class=p>,</span> <span class=p>(</span><span class=n>BatchSize</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>            <span class=c1># Step 4: Losses</span>
</span></span><span class=line><span class=cl>            <span class=n>loss_int</span> <span class=o>=</span> <span class=n>loss_dfnn</span><span class=p>(</span><span class=n>S1tilde_n_batch</span><span class=p>,</span> <span class=n>latent_pred</span><span class=p>)</span>  <span class=c1># latent space loss (S1tilde_n_batch= true latent space)</span>
</span></span><span class=line><span class=cl>            <span class=n>loss_rec</span> <span class=o>=</span> <span class=n>loss_dec</span><span class=p>(</span><span class=n>S1_batch</span><span class=p>,</span> <span class=n>St1_batch</span><span class=p>)</span>      <span class=c1># reconstruction loss </span>
</span></span><span class=line><span class=cl>            <span class=n>total_loss</span> <span class=o>=</span> <span class=n>loss_int</span><span class=o>+</span><span class=n>loss_rec</span> <span class=c1>#alpha * loss_int + beta * loss_rec</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Weights and biases</span>
</span></span><span class=line><span class=cl>        <span class=n>weights_biases</span> <span class=o>=</span> <span class=p>(</span><span class=n>encoder</span><span class=o>.</span><span class=n>trainable_weights</span> <span class=o>+</span> <span class=n>dfnn</span><span class=o>.</span><span class=n>trainable_weights</span> <span class=o>+</span> <span class=n>decoder</span><span class=o>.</span><span class=n>trainable_weights</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Total loss gradient w.r.t. parameters (weights/biases): tape=automatic diff</span>
</span></span><span class=line><span class=cl>        <span class=n>grads</span> <span class=o>=</span> <span class=n>tape</span><span class=o>.</span><span class=n>gradient</span><span class=p>(</span><span class=n>total_loss</span><span class=p>,</span> <span class=n>weights_biases</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1># Step 5: Update weights/biases with one optimizer </span>
</span></span><span class=line><span class=cl>        <span class=n>optimizer</span><span class=o>.</span><span class=n>apply_gradients</span><span class=p>(</span><span class=nb>zip</span><span class=p>(</span><span class=n>grads</span><span class=p>,</span> <span class=n>weights_biases</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>       
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;===========&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>    <span class=c1>## Validation part </span>
</span></span><span class=line><span class=cl>    <span class=s2>&#34;&#34;&#34;===========&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># we store the weights_biases </span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ne</span> <span class=o>%</span> <span class=mi>1000</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>theta_E_stock</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>encoder</span><span class=o>.</span><span class=n>get_weights</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>theta_DFNN_stock</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>dfnn</span><span class=o>.</span><span class=n>get_weights</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=n>theta_D_stock</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>decoder</span><span class=o>.</span><span class=n>get_weights</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># Redo step 3: with encoder from S2_batch [Convolutional autoencoder (CAE)]</span>
</span></span><span class=line><span class=cl>    <span class=c1># with tensorflow and an activation function ELU</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># step a/</span>
</span></span><span class=line><span class=cl>    <span class=n>S2tilde_n</span> <span class=o>=</span> <span class=n>encoder</span><span class=p>(</span><span class=n>S2_reshaped</span><span class=p>,</span><span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>   <span class=c1>#latent space that we want to approximate of shape (BatchSize, latent_dim)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=c1># step b/</span>
</span></span><span class=line><span class=cl>    <span class=n>latent_pred</span> <span class=o>=</span> <span class=n>dfnn</span><span class=p>(</span><span class=n>M2test</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># function to approximate the latent space. shape: (BatchSize, latent_dim)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1># step c/</span>
</span></span><span class=line><span class=cl>    <span class=n>S_reconstructed</span> <span class=o>=</span> <span class=n>decoder</span><span class=p>(</span><span class=n>latent_pred</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> 
</span></span><span class=line><span class=cl>    <span class=n>St2</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S_reconstructed</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>    <span class=c1># Step 4: Losses #for early criterion</span>
</span></span><span class=line><span class=cl>    <span class=n>loss_int</span> <span class=o>=</span> <span class=n>loss_dfnn</span><span class=p>(</span><span class=n>S2tilde_n</span><span class=p>,</span> <span class=n>latent_pred</span><span class=p>)</span>  <span class=c1># latent space loss (S2tilde_n= true latent space)</span>
</span></span><span class=line><span class=cl>    <span class=n>loss_rec</span> <span class=o>=</span> <span class=n>loss_dec</span><span class=p>(</span><span class=n>S2_batch</span><span class=p>,</span> <span class=n>St2</span><span class=p>)</span>      <span class=c1># reconstruction loss </span>
</span></span><span class=line><span class=cl>    <span class=n>total_loss</span> <span class=o>=</span>   <span class=n>loss_int</span> <span class=o>+</span> <span class=n>loss_rec</span>
</span></span><span class=line><span class=cl>         
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>ne</span> <span class=o>%</span> <span class=mi>500</span> <span class=o>==</span> <span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;loss_recStep </span><span class=si>{</span><span class=n>ne</span><span class=si>}</span><span class=s2>/</span><span class=si>{</span><span class=n>N_epochs</span><span class=si>}</span><span class=s2>. Loss testing : </span><span class=si>{</span><span class=n>total_loss</span><span class=o>.</span><span class=n>numpy</span><span class=p>()</span><span class=si>:</span><span class=s2>.6f</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>ne</span><span class=o>+=</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span><span class=o>=</span><span class=n>S2_batch</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span><span class=o>=</span><span class=n>ExactSolution</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span>
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>ExactSolution</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span> <span class=o>=</span><span class=n>St2</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span><span class=o>=</span><span class=n>CompressedSolutionU</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span>
</span></span><span class=line><span class=cl><span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>CompressedSolutionU</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl><span class=c1>#print(np.linalg.norm((S2_batch[10].numpy()-St2[10].numpy())))</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ExactSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ReconstructedCompressedSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>shape S1 training: (64, 1728)
shape S2 validation: (192, 64)
shape M1 parameters: (3, 1728)
shape M2 parameters: (192, 3)
Total number of training parameters: 1728
Maximum iterations: 2500
Number of minibatches: 16.0
Number of minibatches:  16
latent space dim: 3
(None, 3)
(None, 3)
(192, 64)
loss_recStep 0/2500. Loss testing : 0.041778
loss_recStep 500/2500. Loss testing : 0.001538
loss_recStep 1000/2500. Loss testing : 0.000781
loss_recStep 1500/2500. Loss testing : 0.000497
loss_recStep 2000/2500. Loss testing : 0.000385
loss_recStep 2500/2500. Loss testing : 0.000307
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_21_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_21_2.png alt=png loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># validation visualization</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>S2test</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>S2_batch</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S2test</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>      
</span></span><span class=line><span class=cl><span class=n>latent_pred</span> <span class=o>=</span> <span class=n>dfnn</span><span class=p>(</span><span class=n>M2test</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># function to approximate the latent space. shape: (BatchSize, latent_dim)       </span>
</span></span><span class=line><span class=cl><span class=n>S_reconstructed</span> <span class=o>=</span> <span class=n>decoder</span><span class=p>(</span><span class=n>latent_pred</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>St2</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S_reconstructed</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span><span class=o>=</span><span class=n>S2_batch</span><span class=p>[</span><span class=mi>25</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span><span class=o>=</span><span class=n>ExactSolution</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span>
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>ExactSolution</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span> <span class=o>=</span><span class=n>St2</span><span class=p>[</span><span class=mi>25</span><span class=p>]</span><span class=c1>#St[i] #size Nh</span>
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span><span class=o>=</span><span class=n>CompressedSolutionU</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span>
</span></span><span class=line><span class=cl><span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>CompressedSolutionU</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ExactSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ReconstructedCompressedSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>(192, 64)
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_22_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_22_2.png alt=png loading=lazy data-zoomable></div></div></figure></p><h3 id=now-we-can-proceed-with-the-online-step>Now we can proceed with the online step</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34; TESTING set &#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;        Online                     &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=c1># The parameter set is given by $[0.002, 0.005] × [30, 70] × [0.4, 0.6]^2$</span>
</span></span><span class=line><span class=cl><span class=c1># Nt = 20 time instances</span>
</span></span><span class=line><span class=cl><span class=c1># testing values (different from the training ones)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>mu1_values</span> <span class=o>=</span> <span class=mf>0.004</span> <span class=c1># np.linspace(0.002, 0.005, 4)  # 4 valeurs dans [0.002, 0.005]</span>
</span></span><span class=line><span class=cl><span class=n>mu2_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mi>35</span><span class=p>,</span> <span class=mi>65</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>        <span class=c1># 5 valeurs dans [30, 70]</span>
</span></span><span class=line><span class=cl><span class=n>mu3_values</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>linspace</span><span class=p>(</span><span class=mf>0.425</span><span class=p>,</span> <span class=mf>0.575</span><span class=p>,</span> <span class=mi>4</span><span class=p>)</span>       <span class=c1># 5 valeurs dans [0.4, 0.6]</span>
</span></span><span class=line><span class=cl><span class=n>mu4_values</span> <span class=o>=</span> <span class=mf>0.5</span> <span class=c1>#np.linspace(0.4, 0.6, 5)</span>
</span></span><span class=line><span class=cl><span class=n>mu5_values</span> <span class=o>=</span> <span class=n>t_list</span> <span class=c1># additional parameter = time</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu1: &#34;</span><span class=p>,</span><span class=n>mu1_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu2: &#34;</span><span class=p>,</span><span class=n>mu2_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu3: &#34;</span><span class=p>,</span><span class=n>mu3_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;mu4: &#34;</span><span class=p>,</span><span class=n>mu4_values</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>param_combinations</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=n>itertools</span><span class=o>.</span><span class=n>product</span><span class=p>(</span> <span class=n>mu2_values</span><span class=p>,</span> <span class=n>mu3_values</span><span class=p>))</span> 
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>FineSnapshots_testing</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>muParam</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>mu</span> <span class=ow>in</span> <span class=n>param_combinations</span><span class=p>:</span> 
</span></span><span class=line><span class=cl>    <span class=n>mutmp</span><span class=o>=</span><span class=p>[</span><span class=n>mu1_values</span><span class=p>,</span><span class=n>mu</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>mu</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span><span class=n>mu4_values</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>solution</span><span class=p>,</span><span class=n>_</span><span class=o>=</span><span class=n>SolveProblem_BDF2</span><span class=p>([</span><span class=n>mutmp</span><span class=p>],</span><span class=n>FineMesh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>mu_full</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>hstack</span><span class=p>([[</span><span class=n>mu</span><span class=p>]</span> <span class=o>*</span> <span class=nb>len</span><span class=p>(</span><span class=n>solution</span><span class=p>)</span> <span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>(</span><span class=n>mu5_values</span><span class=p>)</span><span class=o>.</span><span class=n>reshape</span><span class=p>((</span><span class=nb>len</span><span class=p>(</span><span class=n>solution</span><span class=p>),</span><span class=mi>1</span><span class=p>))])</span>  <span class=c1># we add time as a parameter mu5</span>
</span></span><span class=line><span class=cl>    <span class=n>mu_full</span> <span class=o>=</span> <span class=n>mu_full</span><span class=o>.</span><span class=n>tolist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=n>muParam</span> <span class=o>+=</span> <span class=n>mu_full</span> 
</span></span><span class=line><span class=cl>    <span class=n>FineSnapshots_testing</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>solution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>solution</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>-----------------------------------
        Online                     
-----------------------------------
mu1:  0.004
mu2:  [35. 45. 55. 65.]
mu3:  [0.425 0.475 0.525 0.575]
mu4:  0.5
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_24_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>FineSnapshotsMat</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>concatenate</span><span class=p>(</span><span class=n>FineSnapshots_testing</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;shape snapshots: &#34;</span><span class=p>,</span> <span class=n>FineSnapshotsMat</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span> <span class=c1>#NS, NumberOfDegreesOfFreedrom (NS=Ntest*NT)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>indices</span> <span class=o>=</span> <span class=nb>list</span><span class=p>(</span><span class=nb>range</span><span class=p>(</span><span class=nb>len</span><span class=p>(</span><span class=n>FineSnapshotsMat</span><span class=p>)))</span> 
</span></span><span class=line><span class=cl><span class=n>FineSnapshots_testing</span> <span class=o>=</span> <span class=p>[</span><span class=n>FineSnapshotsMat</span><span class=p>[</span><span class=n>i</span><span class=p>,:]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>indices</span><span class=p>]</span> <span class=c1>#R^NS=R^Ntest*NT</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>S2</span> <span class=o>=</span> <span class=n>FineSnapshots_testing</span><span class=o>.</span><span class=n>copy</span><span class=p>()</span> <span class=c1># full snapshots</span>
</span></span><span class=line><span class=cl><span class=n>M2</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=n>muParam</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=k>for</span> <span class=n>i</span> <span class=ow>in</span> <span class=n>indices</span><span class=p>])</span> <span class=c1>#full parameters</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;S2 (snapshots for testing) shape:&#34;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;M2 (parameters for testing) shape:&#34;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M2</span><span class=p>))</span>
</span></span></code></pre></div><pre><code>shape snapshots:  (320, 4225)
S2 (snapshots for testing) shape: (320, 4225)
M2 (parameters for testing) shape: (320, 3)
</code></pre><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;        Data  Compression          &#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;-----------------------------------&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>VTS2</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>((</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>S2</span><span class=p>)[</span><span class=mi>0</span><span class=p>],</span><span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>snap</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>S2</span><span class=p>):</span><span class=c1>#FineSnapshotsMat:</span>
</span></span><span class=line><span class=cl>    <span class=n>ExactSolution</span> <span class=o>=</span><span class=n>snap</span> <span class=c1>#size Nh</span>
</span></span><span class=line><span class=cl>    <span class=n>VTS2</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>()</span><span class=nd>@ExactSolution</span> <span class=c1>#snapshot compression</span>
</span></span><span class=line><span class=cl>    <span class=c1>#ReconstructedCompressedSolution = VTS2[i]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span><span class=o>=</span><span class=n>VTS2</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>CompressedSolutionU</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;Compressed size&#34;</span><span class=p>,</span><span class=n>VTS2</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ReconstructedCompressedSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>-----------------------------------
        Data  Compression          
-----------------------------------
Compressed size (320, 64)
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_26_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1>## Normalization</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>## parameters test M2 matrix ##
</span></span></span><span class=line><span class=cl><span class=s2>##
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Testing part</span>
</span></span><span class=line><span class=cl><span class=n>M2test</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>M2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>j</span> <span class=ow>in</span> <span class=nb>range</span><span class=p>(</span><span class=n>M2</span><span class=o>.</span><span class=n>shape</span><span class=p>[</span><span class=mi>1</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>M2test</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=n>M2</span><span class=p>[:,</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>])</span><span class=o>/</span><span class=p>(</span><span class=n>Mmax</span><span class=p>[</span><span class=n>j</span><span class=p>]</span><span class=o>-</span><span class=n>Mmin</span><span class=p>[</span><span class=n>j</span><span class=p>])</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#M2test[:,4]=mu5_values[0] #if one time step</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;
</span></span></span><span class=line><span class=cl><span class=s2>## snapshots test S2 matrix ##
</span></span></span><span class=line><span class=cl><span class=s2>##
</span></span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=n>S2test</span><span class=o>=</span><span class=p>(</span><span class=n>VTS2</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>/</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;===========&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>## Testing part </span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;===========&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>S2test</span><span class=o>.</span><span class=n>shape</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>S2_batch</span><span class=o>=</span><span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S2test</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>      
</span></span><span class=line><span class=cl><span class=n>latent_pred</span> <span class=o>=</span> <span class=n>dfnn</span><span class=p>(</span><span class=n>M2test</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>  <span class=c1># function to approximate the latent space. shape: (BatchSize, latent_dim)       </span>
</span></span><span class=line><span class=cl><span class=n>S_reconstructed</span> <span class=o>=</span> <span class=n>decoder</span><span class=p>(</span><span class=n>latent_pred</span><span class=p>,</span> <span class=n>training</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span> 
</span></span><span class=line><span class=cl><span class=n>St2</span> <span class=o>=</span> <span class=n>tf</span><span class=o>.</span><span class=n>reshape</span><span class=p>(</span><span class=n>S_reconstructed</span><span class=p>,</span> <span class=p>(</span><span class=o>-</span><span class=mi>1</span><span class=p>,</span> <span class=n>NumberOfModes</span><span class=p>))</span>
</span></span><span class=line><span class=cl>     
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span><span class=o>=</span><span class=n>S2_batch</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span> 
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span><span class=o>=</span><span class=n>ExactSolution</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span>
</span></span><span class=line><span class=cl><span class=n>ExactSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>ExactSolution</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span> <span class=c1>#true compressed</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span> <span class=o>=</span><span class=n>St2</span><span class=p>[</span><span class=mi>10</span><span class=p>]</span><span class=c1>#St[i] #size Nh</span>
</span></span><span class=line><span class=cl><span class=n>CompressedSolutionU</span><span class=o>=</span><span class=n>CompressedSolutionU</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span>
</span></span><span class=line><span class=cl><span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>CompressedSolutionU</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>   
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>FineSnapshots_testing</span><span class=p>[</span><span class=mi>10</span><span class=p>])</span><span class=o>.</span><span class=n>show</span><span class=p>()</span> <span class=c1>#true solution FineSnapshots_testing[i]</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ExactSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span> <span class=c1>#true compressed</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ReconstructedCompressedSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span> <span class=c1>#POD-DL-ROM approx</span>
</span></span></code></pre></div><pre><code>(320, 64)
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_28_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_28_2.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_28_3.png alt=png loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;===================&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl><span class=c1>## Testing part accuracy</span>
</span></span><span class=line><span class=cl><span class=s2>&#34;&#34;&#34;===================&#34;&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>L2compressionErrors</span><span class=o>=</span><span class=p>[]</span>
</span></span><span class=line><span class=cl><span class=n>L2</span><span class=o>=</span><span class=n>mass</span><span class=o>.</span><span class=n>assemble</span><span class=p>(</span><span class=n>FineBasis</span><span class=p>[</span><span class=s1>&#39;u&#39;</span><span class=p>],</span><span class=n>nu</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>np</span><span class=o>.</span><span class=n>shape</span><span class=p>(</span><span class=n>VTS2</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=n>i</span><span class=p>,</span><span class=n>snap</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>St2</span><span class=p>[:</span><span class=mi>10</span><span class=p>]):</span>
</span></span><span class=line><span class=cl>    <span class=n>ExactSolution</span><span class=o>=</span><span class=n>FineSnapshots_testing</span><span class=p>[</span><span class=n>i</span><span class=p>]</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>CompressedSolutionU</span><span class=o>=</span><span class=n>snap</span><span class=o>*</span><span class=p>(</span><span class=n>Smax</span><span class=o>-</span><span class=n>Smin</span><span class=p>)</span><span class=o>+</span><span class=n>Smin</span> <span class=c1>#POD_DL_ROM compressed data</span>
</span></span><span class=line><span class=cl>    <span class=n>ReconstructedCompressedSolution</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>dot</span><span class=p>(</span><span class=n>CompressedSolutionU</span><span class=p>,</span> <span class=n>ReducedBasis</span><span class=o>.</span><span class=n>transpose</span><span class=p>())</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=n>norml2ExactSolution</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>ExactSolution</span><span class=o>@</span><span class=p>(</span><span class=n>L2</span><span class=nd>@ExactSolution</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>t</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>abs</span><span class=p>(</span><span class=n>ReconstructedCompressedSolution</span><span class=o>-</span><span class=n>ExactSolution</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>norml2ExactSolution</span> <span class=o>!=</span><span class=mi>0</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>relL2Error</span><span class=o>=</span><span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=nd>@L2@t</span><span class=p>)</span><span class=o>/</span><span class=n>norml2ExactSolution</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>relL2Error</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>sqrt</span><span class=p>(</span><span class=n>t</span><span class=nd>@L2@t</span><span class=p>)</span> <span class=c1>#np.linalg.norm(ReconstructedCompressedSolution-ExactSolution)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>L2compressionErrors</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>relL2Error</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;L2 averaged compression error =&#34;</span><span class=p>,</span> <span class=n>np</span><span class=o>.</span><span class=n>mean</span><span class=p>(</span><span class=n>L2compressionErrors</span><span class=p>))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ExactSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>visualize_solution</span><span class=p>(</span><span class=n>FineMesh</span><span class=p>,</span><span class=n>ReconstructedCompressedSolution</span><span class=p>)</span><span class=o>.</span><span class=n>show</span><span class=p>()</span>
</span></span></code></pre></div><pre><code>(320, 64)
L2 averaged compression error = 0.07518568436754877
</code></pre><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_29_1.png alt=png loading=lazy data-zoomable></div></div></figure></p><p><figure><div class="flex justify-center"><div class=w-100><img src=./poddlrom_29_2.png alt=png loading=lazy data-zoomable></div></div></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python></code></pre></div></div><time class="mt-12 mb-8 block text-xs text-gray-500 ltr:text-right rtl:text-left dark:text-gray-400" datetime=2024-12-13T10:19:20.000Z><span>Last updated on</span>
Dec 13, 2024</time><div class="container mx-auto prose prose-slate lg:prose-xl dark:prose-invert mt-5"><div class="max-w-prose print:hidden"><section class="flex flex-row flex-wrap justify-center pt-4 text-xl"><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://twitter.com/intent/tweet?url=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fpoddlrom%2F&amp;text=The+POD-DL-ROM" title=X aria-label=X id=share-link-x><svg style="height:1em" viewBox="0 0 512 512"><path fill="currentcolor" d="M389.2 48h70.6L305.6 224.2 487 464H345L233.7 318.6 106.5 464H35.8L200.7 275.5 26.8 48H172.4L272.9 180.9 389.2 48zM364.4 421.8h39.1L151.1 88h-42L364.4 421.8z"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.facebook.com/sharer.php?u=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fpoddlrom%2F&amp;t=The+POD-DL-ROM" title=Facebook aria-label=Facebook id=share-link-facebook><svg style="height:1em" viewBox="0 0 24 24"><path fill="currentcolor" d="M22 12c0-5.52-4.48-10-10-10S2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55.0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95z"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="mailto:?subject=The%20POD-DL-ROM&amp;body=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fpoddlrom%2F" title=Email aria-label=Email id=share-link-email><svg style="height:1em" viewBox="0 0 24 24"><path fill="none" stroke="currentcolor" stroke-linecap="round" stroke-width="1.5" d="M16.5 12a4.5 4.5.0 11-9 0 4.5 4.5.0 019 0zm0 0c0 1.657 1.007 3 2.25 3S21 13.657 21 12a9 9 0 10-2.636 6.364M16.5 12V8.25"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="https://www.linkedin.com/shareArticle?url=https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fpoddlrom%2F&amp;title=The+POD-DL-ROM" title=LinkedIn aria-label=LinkedIn id=share-link-linkedin><svg style="height:1em" height="1em" viewBox="0 0 448 512"><path fill="currentcolor" d="M416 32H31.9C14.3 32 0 46.5.0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6.0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3.0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2.0 38.5 17.3 38.5 38.5.0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6.0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2.0 79.7 44.3 79.7 101.9V416z"/></svg>
</a><a target=_blank rel=noopener class="m-1 rounded-md bg-neutral-300 p-1.5 text-neutral-700 hover:bg-primary-500 hover:text-neutral-300 dark:bg-neutral-700 dark:text-neutral-300 dark:hover:bg-primary-400 dark:hover:text-neutral-800" href="whatsapp://send?text=The+POD-DL-ROM%20https%3A%2F%2Freducedbasis.github.io%2Fpost%2Fpoddlrom%2F" title=WhatsApp aria-label=WhatsApp id=share-link-whatsapp><svg style="height:1em" viewBox="0 0 256 256" fill="currentcolor"><path d="m187.58 144.84-32-16a8 8 0 00-8 .5l-14.69 9.8a40.55 40.55.0 01-16-16l9.8-14.69a8 8 0 00.5-8l-16-32A8 8 0 00104 64a40 40 0 00-40 40 88.1 88.1.0 0088 88 40 40 0 0040-40 8 8 0 00-4.42-7.16zM152 176a72.08 72.08.0 01-72-72 24 24 0 0119.29-23.54l11.48 23L101 118a8 8 0 00-.73 7.51 56.47 56.47.0 0030.15 30.15A8 8 0 00138 155l14.61-9.74 23 11.48A24 24 0 01152 176zM128 24A104 104 0 0036.18 176.88l-11.35 34.05a16 16 0 0020.24 20.24l34.05-11.35A104 104 0 10128 24zm0 192a87.87 87.87.0 01-44.06-11.81 8 8 0 00-6.54-.67L40 216l12.47-37.4a8 8 0 00-.66-6.54A88 88 0 11128 216z"/></svg></a></section><div class="flex pt-12 pb-4"><div class=place-self-center><div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">Authors</div><div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300"></div><div class="text-2xl sm:text-lg pt-1"><div class="flex flex-wrap text-neutral-500 dark:text-neutral-300"><a class="pr-2 transition-transform hover:scale-125 hover:text-primary-700 dark:hover:text-primary-400" style=will-change:transform href=mailto:reducedbases@gmail.com aria-label=At-Symbol><svg style="height:1em" viewBox="0 0 24 24"><path fill="none" stroke="currentcolor" stroke-linecap="round" stroke-width="1.5" d="M16.5 12a4.5 4.5.0 11-9 0 4.5 4.5.0 019 0zm0 0c0 1.657 1.007 3 2.25 3S21 13.657 21 12a9 9 0 10-2.636 6.364M16.5 12V8.25"/></svg></a></div></div></div></div><div class="pt-1 no-prose w-full"><hr class="border-dotted border-neutral-300 dark:border-neutral-600"><div class="flex flex-col md:flex-row flex-nowrap justify-between gap-5 pt-2"><div><a class="group flex no-underline" href=/post/rsvd/><span class="mt-[-0.3rem] me-2 text-neutral-700 transition-transform group-hover:-translate-x-[2px] group-hover:text-primary-600 dark:text-neutral dark:group-hover:text-primary-400"><span class="ltr:inline rtl:hidden">&larr;</span></span>
<span class="flex flex-col"><span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">random Singular Value Decomposition</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">Dec 13, 2024</span></span></a></div><div></div></div></div></div></div></main></article></div></div><div class=page-footer><footer class="container mx-auto flex flex-col justify-items-center text-sm leading-6 mt-24 mb-4 text-slate-700 dark:text-slate-200"><p class="powered-by text-center">Thanks</p><p class="powered-by footer-license-icons"><a href=https://creativecommons.org/licenses/by-nc-nd/4.0 rel="noopener noreferrer" target=_blank aria-label="Creative Commons"><i class="fab fa-creative-commons fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-by fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nc fa-2x" aria-hidden=true></i>
<i class="fab fa-creative-commons-nd fa-2x" aria-hidden=true></i></a></p><p class="powered-by text-center">Published with <a href="https://hugoblox.com/?utm_campaign=poweredby" target=_blank rel=noopener>Hugo Blox Builder</a> — the free, <a href=https://github.com/HugoBlox/hugo-blox-builder target=_blank rel=noopener>open source</a> website builder that empowers creators.</p></footer></div></body></html>